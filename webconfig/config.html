<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>InkSight 配置管理</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--bk:#1a1a1a;--gy:#888;--bg:#fafaf7;--bd:#d4d4cf;--green:#16a34a;--red:#dc2626}
body{font-family:'Inter',-apple-system,sans-serif;background:linear-gradient(135deg,#f5f5f0,#e8e8e0);color:var(--bk);line-height:1.6;min-height:100vh;padding:24px}
.container{max-width:800px;margin:0 auto}
.card{background:#fff;border-radius:20px;box-shadow:0 8px 40px rgba(0,0,0,.08);padding:32px;margin-bottom:20px}
h1{font-size:1.8rem;margin-bottom:8px}
.subtitle{color:var(--gy);font-size:.9rem;margin-bottom:24px}
.inp,.sel{width:100%;padding:10px 12px;font-size:.9rem;border:1px solid var(--bd);border-radius:8px;background:var(--bg);outline:none}
.inp:focus,.sel:focus{border-color:var(--bk)}
.fg{margin-bottom:16px}
.lbl{display:block;font-size:.85rem;font-weight:600;margin-bottom:6px}
.btn{padding:12px 24px;font-size:.9rem;font-weight:600;color:#fff;background:var(--bk);border:none;border-radius:10px;cursor:pointer}
.btn:hover{background:#333}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn-secondary{background:#6b7280}
.btn-secondary:hover{background:#4b5563}
.btn-outline{background:#fff;color:var(--bk);border:1px solid var(--bd)}
.btn-outline:hover{background:var(--bg)}
.cg{display:flex;flex-wrap:wrap;gap:8px}
.ch{padding:6px 12px;font-size:.8rem;border:1px solid var(--bd);border-radius:18px;cursor:pointer;background:#fff;color:var(--gy);position:relative}
.ch:hover{border-color:var(--bk);color:var(--bk)}
.ch.sel{background:var(--bk);color:#fff;border-color:var(--bk)}
.ch[data-tip]:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--bk);color:#fff;padding:4px 10px;border-radius:6px;font-size:.7rem;white-space:nowrap;z-index:10;pointer-events:none}
.ch[data-tip]:hover::before{content:'';position:absolute;bottom:calc(100% + 2px);left:50%;transform:translateX(-50%);border:4px solid transparent;border-top-color:var(--bk);z-index:10}
.pg{display:flex;gap:8px;flex-wrap:wrap}
.pi{flex:1;padding:8px;text-align:center;font-size:.8rem;border:1px solid var(--bd);border-radius:8px;cursor:pointer;background:#fff;color:var(--gy);min-width:70px}
.pi:hover{background:var(--bg)}
.pi.sel{background:var(--bk);color:#fff}
.hist-item{padding:12px;border:1px solid var(--bd);border-radius:8px;margin-bottom:8px;cursor:pointer;background:#fff}
.hist-item:hover{border-color:var(--bk);background:var(--bg)}
.hist-item.active{border-color:var(--bk);background:var(--bg)}
.hist-meta{font-size:.75rem;color:var(--gy);margin-bottom:6px}
.hist-content{font-size:.85rem;line-height:1.6}
.hist-actions{margin-top:8px;display:flex;gap:8px}
.hist-actions button{padding:4px 12px;font-size:.75rem;border:1px solid var(--bd);border-radius:6px;cursor:pointer;background:#fff}
.hist-actions button:hover{background:var(--bg)}
.tc{margin-bottom:6px}
.tcl{font-size:.68rem;color:var(--gy);margin-bottom:3px;font-weight:500}

/* Toast notifications */
#toastContainer{position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{padding:12px 20px;border-radius:10px;font-size:.85rem;font-weight:500;box-shadow:0 4px 20px rgba(0,0,0,.12);transform:translateX(120%);transition:transform .3s ease,opacity .3s ease;opacity:0;pointer-events:auto;max-width:360px}
.toast.show{transform:translateX(0);opacity:1}
.toast-success{background:#dcfce7;color:#15803d;border:1px solid #bbf7d0}
.toast-error{background:#fef2f2;color:#dc2626;border:1px solid #fecaca}
.toast-info{background:#dbeafe;color:#1e40af;border:1px solid #bfdbfe}

/* Time slot editor */
.ts-row{display:flex;gap:6px;align-items:center;margin-bottom:6px;flex-wrap:wrap}
.ts-row .inp,.ts-row .sel{width:auto;flex:none}
.ts-modes{display:flex;flex-wrap:wrap;gap:4px;flex:1;min-width:200px}
.ts-modes .ch{padding:3px 8px;font-size:.72rem}

/* Preview modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
.modal-overlay.active{opacity:1;pointer-events:auto}
.modal-content{background:#fff;border-radius:16px;padding:24px;max-width:520px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.modal-content h3{font-size:1.1rem;margin-bottom:12px}
.modal-close{float:right;border:none;background:none;font-size:1.2rem;cursor:pointer;color:var(--gy)}

/* Confirm dialog */
.confirm-bar{display:flex;gap:8px;margin-top:12px;justify-content:flex-end}
.confirm-bar .btn{padding:8px 18px;font-size:.82rem}

/* Strategy description */
.strategy-desc{font-size:.72rem;color:var(--gy);margin-top:6px;min-height:1.2em}

/* Custom mode editor */
.mode-list{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
.mode-item{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border:1px solid var(--bd);border-radius:10px;background:#fff}
.mode-item:hover{border-color:var(--bk);background:var(--bg)}
.mode-meta{flex:1;min-width:0}
.mode-meta strong{font-size:.9rem}
.mode-meta .mode-src{font-size:.68rem;padding:2px 6px;border-radius:4px;margin-left:6px}
.mode-src-builtin{background:#dbeafe;color:#1e40af}
.mode-src-builtin_json{background:#e0e7ff;color:#4338ca}
.mode-src-custom{background:#dcfce7;color:#15803d}
.mode-meta p{font-size:.75rem;color:var(--gy);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.mode-actions{display:flex;gap:6px;flex-shrink:0;margin-left:12px}
.mode-actions button{padding:4px 10px;font-size:.75rem;border:1px solid var(--bd);border-radius:6px;cursor:pointer;background:#fff}
.mode-actions button:hover{background:var(--bg)}
.mode-actions .btn-del{color:var(--red);border-color:#fecaca}
.mode-actions .btn-del:hover{background:#fef2f2}
.json-editor{width:100%;min-height:260px;font-family:'Menlo','Monaco','Courier New',monospace;font-size:.8rem;padding:12px;border:1px solid var(--bd);border-radius:10px;background:#fafaf7;resize:vertical;line-height:1.5;tab-size:2}
.json-editor:focus{border-color:var(--bk);outline:none}
.json-error{font-size:.75rem;color:var(--red);margin-top:4px;min-height:1.1em}
.tpl-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;margin-bottom:12px}
.tpl-card{padding:10px;border:1px solid var(--bd);border-radius:10px;cursor:pointer;background:#fff;text-align:center}
.tpl-card:hover{border-color:var(--bk);background:var(--bg)}
.tpl-card strong{font-size:.85rem;display:block;margin-bottom:4px}
.tpl-card span{font-size:.7rem;color:var(--gy)}
</style>
</head>
<body>
<div id="toastContainer"></div>

<div id="previewModal" class="modal-overlay" onclick="if(event.target===this)closePreviewModal()">
<div class="modal-content">
<button class="modal-close" onclick="closePreviewModal()">&times;</button>
<h3>配置预览</h3>
<div id="previewModeSelect" style="margin-bottom:12px"></div>
<div style="text-align:center">
<img id="previewImg" style="max-width:100%;border:2px solid #d4d4d4;border-radius:6px;background:#f5f5f5" alt="Preview">
<div id="previewStatus" style="font-size:.75rem;color:var(--gy);margin-top:8px"></div>
</div>
</div>
</div>

<div id="confirmModal" class="modal-overlay" onclick="if(event.target===this)closeConfirm(false)">
<div class="modal-content" style="max-width:400px">
<p id="confirmMsg" style="font-size:.9rem;line-height:1.6"></p>
<div class="confirm-bar">
<button class="btn btn-outline" onclick="closeConfirm(false)">取消</button>
<button class="btn" onclick="closeConfirm(true)">确定</button>
</div>
</div>
</div>

<div class="container">
<div class="card">
<h1>InkSight 配置管理</h1>
<p class="subtitle">在线修改设备配置，无需重新连接热点</p>

<div class="fg">
<label class="lbl">设备 MAC 地址</label>
<input type="text" class="inp" id="macIn" placeholder="例如: 88:56:A6:7B:C7:0C">
<div style="font-size:.75rem;color:var(--gy);margin-top:4px">在设备屏幕底部或初始配置页面可以找到，也可以通过 URL 参数传递</div>
</div>

<div style="display:flex;gap:8px;flex-wrap:wrap">
<button class="btn" onclick="loadConfig()" id="loadBtn" style="flex:1;min-width:120px">加载当前配置</button>
<button class="btn btn-secondary" onclick="loadHistory()" id="historyBtn" style="flex:1;min-width:120px">查看历史配置</button>
<button class="btn" onclick="triggerRefresh()" style="flex:1;min-width:120px;background:var(--green)">立即刷新</button>
</div>

<div id="historyList" style="display:none;margin-top:16px"></div>
</div>

<div id="configForm" style="display:none">
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
<h2 style="font-size:1.3rem">设备配置</h2>
<div style="display:flex;gap:6px">
<button class="btn btn-outline" onclick="exportConfig()" style="padding:6px 12px;font-size:.75rem">导出 JSON</button>
<button class="btn btn-outline" onclick="document.getElementById('importFile').click()" style="padding:6px 12px;font-size:.75rem">导入 JSON</button>
<input type="file" id="importFile" accept=".json" style="display:none" onchange="importConfig(event)">
</div>
</div>

<div class="fg">
<label class="lbl">昵称</label>
<input type="text" class="inp" id="nickname" placeholder="可选">
</div>

<div class="fg">
<label class="lbl">内容模式（多选）</label>
<div class="cg" id="modes">
<span class="ch" data-m="STOIC" onclick="tc(this)">STOIC 斯多葛</span>
<span class="ch" data-m="ROAST" onclick="tc(this)">ROAST 毒舌</span>
<span class="ch" data-m="ZEN" onclick="tc(this)">ZEN 禅意</span>
<span class="ch" data-m="DAILY" onclick="tc(this)">DAILY 每日</span>
<span class="ch" data-m="BRIEFING" onclick="tc(this)">BRIEFING 简报</span>
<span class="ch" data-m="ARTWALL" onclick="tc(this)">ARTWALL 画廊</span>
<span class="ch" data-m="RECIPE" onclick="tc(this)">RECIPE 食谱</span>
<span class="ch" data-m="FITNESS" onclick="tc(this)">FITNESS 健身</span>
<span class="ch" data-m="POETRY" onclick="tc(this)">POETRY 诗词</span>
<span class="ch" data-m="COUNTDOWN" onclick="tc(this)">COUNTDOWN 倒计时</span>
</div>
</div>

<div class="fg">
<label class="lbl">刷新策略</label>
<div class="pg" id="strategy">
<div class="pi" data-v="random" onclick="selectStrategy(this)">随机轮换</div>
<div class="pi" data-v="cycle" onclick="selectStrategy(this)">循环轮换</div>
<div class="pi" data-v="time_slot" onclick="selectStrategy(this)">时段绑定</div>
<div class="pi" data-v="smart" onclick="selectStrategy(this)">智能模式</div>
</div>
<div class="strategy-desc" id="strategyDesc"></div>
</div>

<div class="fg" id="timeSlotSection" style="display:none">
<label class="lbl">时段规则</label>
<div id="timeSlotRules"></div>
<button type="button" onclick="addTimeSlotRule()" style="margin-top:8px;padding:6px 14px;font-size:.8rem;border:1px solid var(--bd);border-radius:6px;cursor:pointer;background:#fff">+ 添加时段</button>
<div style="font-size:.7rem;color:var(--gy);margin-top:4px">为不同时间段配置不同的内容模式，未覆盖的时段使用随机选择</div>
</div>

<div class="fg">
<label class="lbl">语言偏好</label>
<div class="pg" id="language">
<div class="pi" data-v="zh" onclick="sp(this,'language')">中文为主</div>
<div class="pi" data-v="en" onclick="sp(this,'language')">英文为主</div>
<div class="pi" data-v="mixed" onclick="sp(this,'language')">中英混合</div>
</div>
</div>

<div class="fg">
<label class="lbl">内容调性</label>
<div class="pg" id="tone">
<div class="pi" data-v="positive" onclick="sp(this,'tone')">积极鼓励</div>
<div class="pi" data-v="neutral" onclick="sp(this,'tone')">中性克制</div>
<div class="pi" data-v="deep" onclick="sp(this,'tone')">深沉内省</div>
<div class="pi" data-v="humor" onclick="sp(this,'tone')">轻松幽默</div>
</div>
</div>

<div class="fg">
<label class="lbl">角色语气</label>
<div class="tc"><div class="tcl">文学</div><div class="cg">
<span class="ch" data-t="鲁迅" data-tip="犀利讽刺，针砭时弊" onclick="tc(this)">鲁迅</span>
<span class="ch" data-t="王小波" data-tip="黑色幽默，自由不羁" onclick="tc(this)">王小波</span>
<span class="ch" data-t="张爱玲" data-tip="冷峻细腻，洞察人性" onclick="tc(this)">张爱玲</span>
<span class="ch" data-t="村上春树" data-tip="孤独美学，淡淡忧伤" onclick="tc(this)">村上春树</span>
</div></div>
<div class="tc"><div class="tcl">影视</div><div class="cg">
<span class="ch" data-t="王家卫" data-tip="文艺腔调，情绪留白" onclick="tc(this)">王家卫</span>
<span class="ch" data-t="周星驰" data-tip="无厘头喜剧，笑中带泪" onclick="tc(this)">周星驰</span>
<span class="ch" data-t="甄嬛" data-tip="宫斗话术，步步为营" onclick="tc(this)">甄嬛</span>
<span class="ch" data-t="白展堂" data-tip="江湖气息，搞笑担当" onclick="tc(this)">白展堂</span>
</div></div>
<div class="tc"><div class="tcl">哲学</div><div class="cg">
<span class="ch" data-t="苏格拉底" data-tip="追问本质，反诘启发" onclick="tc(this)">苏格拉底</span>
<span class="ch" data-t="庄子" data-tip="逍遥自在，万物齐同" onclick="tc(this)">庄子</span>
<span class="ch" data-t="尼采" data-tip="超人意志，永恒回归" onclick="tc(this)">尼采</span>
</div></div>
<div class="tc"><div class="tcl">AI / 科幻</div><div class="cg">
<span class="ch" data-t="JARVIS" data-tip="智能管家，优雅高效" onclick="tc(this)">JARVIS</span>
<span class="ch" data-t="智子" data-tip="冷酷理性，降维打击" onclick="tc(this)">智子</span>
<span class="ch" data-t="马文" data-tip="偏执型机器人，宇宙级丧" onclick="tc(this)">马文</span>
</div></div>
<div style="margin-top:6px">
<input type="text" class="inp" id="custTone" placeholder="或自定义：东北大爷、川普...">
</div>
</div>

<div class="fg">
<label class="lbl">地理位置</label>
<input type="text" class="inp" id="city" placeholder="城市名">
</div>

<div class="fg">
<label class="lbl">AI 模型提供商</label>
<select class="sel" id="llmProvider" onchange="updateModels()">
<option value="deepseek">Deepseek</option>
<option value="aliyun">阿里百炼</option>
<option value="moonshot">月之暗面</option>
</select>
</div>

<div class="fg">
<label class="lbl">AI 模型</label>
<select class="sel" id="llmModel"></select>
</div>

<div class="fg">
<label class="lbl">刷新间隔（分钟）</label>
<input type="number" class="inp" id="interval" min="10" max="1440" placeholder="60">
</div>

<div class="fg" id="countdownSection">
<label class="lbl">倒计时事件（COUNTDOWN 模式使用）</label>
<div id="countdownEvents"></div>
<button type="button" onclick="addCountdownEvent()" style="margin-top:8px;padding:6px 14px;font-size:.8rem;border:1px solid var(--bd);border-radius:6px;cursor:pointer;background:#fff">+ 添加事件</button>
<div style="font-size:.7rem;color:var(--gy);margin-top:4px">最多 10 个事件，倒计时显示最近 3 个</div>
</div>

<div style="display:flex;gap:8px;flex-wrap:wrap">
<button class="btn" onclick="saveConfig()" style="flex:1">保存配置</button>
<button class="btn btn-outline" onclick="openPreviewModal()" style="flex:1">预览效果</button>
</div>
</div>
</div>

<!-- Custom mode management -->
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
<h2 style="font-size:1.3rem">自定义模式</h2>
<div style="display:flex;gap:6px">
<button class="btn btn-outline" onclick="refreshModeList()" style="padding:6px 12px;font-size:.75rem">刷新列表</button>
<button class="btn" onclick="openModeEditor()" style="padding:6px 12px;font-size:.75rem">+ 新建模式</button>
</div>
</div>
<div id="modeList" class="mode-list">
<div style="color:var(--gy);font-size:.85rem;text-align:center;padding:16px">加载中...</div>
</div>
</div>

<!-- Mode editor modal -->
<div id="modeEditorModal" class="modal-overlay" onclick="if(event.target===this)closeModeEditor()">
<div class="modal-content" style="max-width:700px">
<button class="modal-close" onclick="closeModeEditor()">&times;</button>
<h3 id="modeEditorTitle">新建自定义模式</h3>

<div style="margin:12px 0">
<label class="lbl">从模板开始</label>
<div class="tpl-grid">
<div class="tpl-card" onclick="fillModeTemplate('quote')"><strong>语录模式</strong><span>居中文本 + 作者</span></div>
<div class="tpl-card" onclick="fillModeTemplate('list')"><strong>列表模式</strong><span>标题 + 项目列表</span></div>
<div class="tpl-card" onclick="fillModeTemplate('zen')"><strong>极简模式</strong><span>大字居中单字</span></div>
<div class="tpl-card" onclick="fillModeTemplate('sections')"><strong>分栏模式</strong><span>多区块 + 图标</span></div>
</div>
</div>

<div class="fg">
<label class="lbl">模式定义 (JSON)</label>
<textarea class="json-editor" id="modeJsonIn" spellcheck="false" oninput="validateModeJson()"></textarea>
<div class="json-error" id="modeJsonError"></div>
</div>

<div style="display:flex;gap:8px">
<button class="btn" onclick="saveModeDefinition()" style="flex:1">保存模式</button>
<button class="btn btn-outline" onclick="previewCustomMode()" style="flex:1">预览效果</button>
</div>
</div>
</div>

</div>

<script>
const API_BASE = window.location.origin;

const llmModels = {
  deepseek: [{v:'deepseek-chat',n:'DeepSeek Chat'}],
  aliyun: [{v:'qwen-max',n:'通义千问 Max'},{v:'qwen-plus',n:'通义千问 Plus'},{v:'qwen-turbo',n:'通义千问 Turbo'},{v:'deepseek-v3',n:'DeepSeek V3'},{v:'kimi-2.5',n:'Kimi 2.5'},{v:'glm-4-plus',n:'智谱 GLM-4 Plus'}],
  moonshot: [{v:'moonshot-v1-8k',n:'Kimi K1.5'},{v:'moonshot-v1-32k',n:'Kimi K1.5 32K'},{v:'kimi-k2-turbo-preview',n:'Kimi K2 Turbo'}]
};

const strategyDescs = {
  random: '从已启用的模式中随机选取',
  cycle: '按顺序循环切换已启用的模式',
  time_slot: '根据时间段显示不同内容模式（需配置时段规则）',
  smart: '根据时间段自动匹配最佳模式（早餐建议/科技简报/运动计划等）'
};

const ALL_MODES = ['STOIC','ROAST','ZEN','DAILY','BRIEFING','ARTWALL','RECIPE','FITNESS','POETRY','COUNTDOWN'];

// ── Toast notifications ──────────────────────────────────────

function showToast(msg, type='info', duration=3000) {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = `toast toast-${type}`;
  t.textContent = msg;
  c.appendChild(t);
  requestAnimationFrame(() => t.classList.add('show'));
  setTimeout(() => {
    t.classList.remove('show');
    setTimeout(() => t.remove(), 300);
  }, duration);
}

// ── Confirm dialog (replaces native confirm) ─────────────────

let _confirmResolve = null;
function showConfirm(msg) {
  return new Promise(resolve => {
    _confirmResolve = resolve;
    document.getElementById('confirmMsg').textContent = msg;
    document.getElementById('confirmModal').classList.add('active');
  });
}
function closeConfirm(result) {
  document.getElementById('confirmModal').classList.remove('active');
  if (_confirmResolve) { _confirmResolve(result); _confirmResolve = null; }
}

// ── Basic UI helpers ─────────────────────────────────────────

function tc(el) { el.classList.toggle('sel'); }

function sp(el, group) {
  document.querySelectorAll(`#${group} .pi`).forEach(i => i.classList.remove('sel'));
  el.classList.add('sel');
}

function selectStrategy(el) {
  sp(el, 'strategy');
  const v = el.dataset.v;
  document.getElementById('strategyDesc').textContent = strategyDescs[v] || '';
  document.getElementById('timeSlotSection').style.display = v === 'time_slot' ? 'block' : 'none';
}

function updateModels() {
  const provider = document.getElementById('llmProvider').value;
  const sel = document.getElementById('llmModel');
  sel.innerHTML = '';
  (llmModels[provider] || []).forEach(m => {
    const opt = document.createElement('option');
    opt.value = m.v;
    opt.textContent = m.n;
    sel.appendChild(opt);
  });
}

// ── Time slot rule editor ────────────────────────────────────

function addTimeSlotRule(startHour=9, endHour=12, modes=[]) {
  const container = document.getElementById('timeSlotRules');
  if (container.children.length >= 12) { showToast('最多添加 12 个时段', 'error'); return; }

  const row = document.createElement('div');
  row.className = 'ts-row';

  let modesHtml = ALL_MODES.map(m => {
    const sel = modes.includes(m) ? ' sel' : '';
    return `<span class="ch${sel}" data-m="${m}" onclick="tc(this)">${m}</span>`;
  }).join('');

  row.innerHTML = `
    <input type="number" class="inp" min="0" max="23" value="${startHour}" style="width:60px;padding:6px 8px;font-size:.8rem" placeholder="起">
    <span style="color:var(--gy)">—</span>
    <input type="number" class="inp" min="0" max="24" value="${endHour}" style="width:60px;padding:6px 8px;font-size:.8rem" placeholder="止">
    <span style="color:var(--gy);font-size:.75rem">时</span>
    <div class="ts-modes">${modesHtml}</div>
    <button onclick="this.parentElement.remove()" style="padding:4px 8px;border:1px solid var(--bd);border-radius:6px;cursor:pointer;background:#fff;color:var(--red);font-size:.8rem">✕</button>
  `;
  container.appendChild(row);
}

function getTimeSlotRules() {
  const rules = [];
  document.querySelectorAll('#timeSlotRules .ts-row').forEach(row => {
    const inputs = row.querySelectorAll('input[type=number]');
    const startHour = parseInt(inputs[0].value) || 0;
    const endHour = parseInt(inputs[1].value) || 24;
    const modes = [];
    row.querySelectorAll('.ts-modes .ch.sel').forEach(el => modes.push(el.dataset.m));
    if (modes.length > 0) rules.push({ startHour, endHour, modes });
  });
  return rules;
}

function fillTimeSlotRules(rules) {
  const container = document.getElementById('timeSlotRules');
  container.innerHTML = '';
  (rules || []).forEach(r => {
    addTimeSlotRule(r.startHour || 0, r.endHour || 24, r.modes || []);
  });
}

// ── Config load / save ───────────────────────────────────────

async function loadConfig() {
  const mac = document.getElementById('macIn').value.trim();
  if (!mac) { showToast('请输入 MAC 地址', 'error'); return; }

  try {
    const res = await fetch(`${API_BASE}/api/config/${mac}`);
    if (!res.ok) { showToast('未找到该设备的配置', 'error'); return; }
    const cfg = await res.json();
    fillForm(cfg);
    document.getElementById('configForm').style.display = 'block';
    document.getElementById('historyList').style.display = 'none';
    showToast('配置加载成功', 'success');
  } catch (e) {
    showToast('加载失败: ' + e.message, 'error');
  }
}

async function loadHistory() {
  const mac = document.getElementById('macIn').value.trim();
  if (!mac) { showToast('请输入 MAC 地址', 'error'); return; }

  try {
    const res = await fetch(`${API_BASE}/api/config/${mac}/history`);
    if (!res.ok) { showToast('未找到历史配置', 'error'); return; }
    const data = await res.json();
    const configs = data.configs || [];
    if (configs.length === 0) { showToast('暂无历史配置', 'info'); return; }

    const strategyNames = {random:'随机',cycle:'循环',time_slot:'时段绑定',smart:'智能'};
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '<h3 style="font-size:1.1rem;margin-bottom:12px">历史配置</h3>';

    configs.forEach((cfg) => {
      const isActive = cfg.is_active === 1;
      const date = new Date(cfg.created_at).toLocaleString('zh-CN');
      const item = document.createElement('div');
      item.className = 'hist-item' + (isActive ? ' active' : '');
      item.innerHTML = `
        <div class="hist-meta">
          <strong>#${cfg.id}</strong> · ${date} ${isActive ? '<span style="color:#22c55e">● 当前使用</span>' : ''}
        </div>
        <div class="hist-content">
          <strong>模式:</strong> ${cfg.modes.join(', ')}<br>
          <strong>刷新:</strong> ${strategyNames[cfg.refresh_strategy] || cfg.refresh_strategy} / ${cfg.refresh_interval}分钟<br>
          <strong>城市:</strong> ${cfg.city} · <strong>AI:</strong> ${cfg.llm_provider}/${cfg.llm_model}
        </div>
        <div class="hist-actions">
          <button onclick="useHistoryConfig(${cfg.id})">编辑此配置</button>
          ${!isActive ? `<button onclick="activateConfig(${cfg.id})">使用此配置</button>` : ''}
        </div>
      `;
      historyList.appendChild(item);
    });

    historyList.style.display = 'block';
    document.getElementById('configForm').style.display = 'none';
  } catch (e) {
    showToast('加载失败: ' + e.message, 'error');
  }
}

async function useHistoryConfig(configId) {
  const mac = document.getElementById('macIn').value.trim();
  try {
    const res = await fetch(`${API_BASE}/api/config/${mac}/history`);
    const data = await res.json();
    const cfg = data.configs.find(c => c.id === configId);
    if (!cfg) { showToast('配置不存在', 'error'); return; }
    fillForm(cfg);
    document.getElementById('configForm').style.display = 'block';
    document.getElementById('historyList').style.display = 'none';
    showToast('已加载历史配置，可以编辑后保存', 'info');
  } catch (e) {
    showToast('加载失败: ' + e.message, 'error');
  }
}

async function activateConfig(configId) {
  const mac = document.getElementById('macIn').value.trim();
  const ok = await showConfirm('确定要激活此配置吗？设备将在下次刷新时应用。');
  if (!ok) return;

  try {
    const res = await fetch(`${API_BASE}/api/config/${mac}/activate/${configId}`, { method: 'PUT' });
    if (!res.ok) throw new Error('激活失败');
    showToast('配置已激活，设备将在下次刷新时应用', 'success');
    loadHistory();
  } catch (e) {
    showToast('激活失败: ' + e.message, 'error');
  }
}

function fillForm(cfg) {
  document.getElementById('nickname').value = cfg.nickname || '';
  document.getElementById('city').value = cfg.city || '杭州';
  document.getElementById('interval').value = cfg.refresh_interval || 60;

  // Modes
  document.querySelectorAll('#modes .ch').forEach(el => {
    el.classList.remove('sel');
    if (cfg.modes && cfg.modes.includes(el.dataset.m)) el.classList.add('sel');
  });

  // Strategy
  const strategy = cfg.refresh_strategy || 'random';
  document.querySelectorAll('#strategy .pi').forEach(el => {
    el.classList.remove('sel');
    if (el.dataset.v === strategy) {
      el.classList.add('sel');
      selectStrategy(el);
    }
  });

  // Language
  document.querySelectorAll('#language .pi').forEach(el => {
    el.classList.remove('sel');
    if (el.dataset.v === cfg.language) el.classList.add('sel');
  });

  // Tone
  document.querySelectorAll('#tone .pi').forEach(el => {
    el.classList.remove('sel');
    if (el.dataset.v === cfg.content_tone) el.classList.add('sel');
  });

  // Character Tones
  document.querySelectorAll('#configForm .tc .ch').forEach(el => {
    el.classList.remove('sel');
    if (cfg.character_tones && cfg.character_tones.includes(el.dataset.t)) el.classList.add('sel');
  });

  const builtinTones = ['鲁迅','王小波','张爱玲','村上春树','王家卫','周星驰','甄嬛','白展堂','苏格拉底','庄子','尼采','JARVIS','智子','马文'];
  const customTones = (cfg.character_tones || []).filter(t => !builtinTones.includes(t));
  document.getElementById('custTone').value = customTones.length > 0 ? customTones.join(', ') : '';

  // LLM
  document.getElementById('llmProvider').value = cfg.llm_provider || 'deepseek';
  updateModels();
  document.getElementById('llmModel').value = cfg.llm_model || 'deepseek-chat';

  // Countdown events
  fillCountdownEvents(cfg.countdown_events || cfg.countdownEvents || []);

  // Time slot rules
  fillTimeSlotRules(cfg.time_slot_rules || cfg.timeSlotRules || []);
}

function collectFormData() {
  const mac = document.getElementById('macIn').value.trim();
  const modes = [];
  document.querySelectorAll('#modes .ch.sel').forEach(el => modes.push(el.dataset.m));

  const characterTones = [];
  document.querySelectorAll('#configForm .tc .ch.sel').forEach(el => characterTones.push(el.dataset.t));
  const custTone = document.getElementById('custTone').value.trim();
  if (custTone) {
    custTone.split(/[,，、]/).forEach(t => { const trimmed = t.trim(); if (trimmed) characterTones.push(trimmed); });
  }

  return {
    mac,
    nickname: document.getElementById('nickname').value.trim(),
    modes,
    refreshStrategy: document.querySelector('#strategy .pi.sel')?.dataset.v || 'random',
    characterTones,
    language: document.querySelector('#language .pi.sel')?.dataset.v || 'zh',
    contentTone: document.querySelector('#tone .pi.sel')?.dataset.v || 'neutral',
    city: document.getElementById('city').value.trim() || '杭州',
    llmProvider: document.getElementById('llmProvider').value,
    llmModel: document.getElementById('llmModel').value,
    refreshInterval: parseInt(document.getElementById('interval').value) || 60,
    countdownEvents: getCountdownEvents(),
    timeSlotRules: getTimeSlotRules()
  };
}

async function saveConfig() {
  const data = collectFormData();
  if (!data.mac) { showToast('请输入 MAC 地址', 'error'); return; }
  if (data.modes.length === 0) { showToast('请至少选择一个内容模式', 'error'); return; }

  try {
    const res = await fetch(`${API_BASE}/api/config`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    if (!res.ok) throw new Error('保存失败');
    showToast('配置保存成功！设备将在下次刷新时应用', 'success');
  } catch (e) {
    showToast('保存失败: ' + e.message, 'error');
  }
}

// ── Trigger immediate refresh ────────────────────────────────

async function triggerRefresh() {
  const mac = document.getElementById('macIn').value.trim();
  if (!mac) { showToast('请先输入 MAC 地址', 'error'); return; }

  try {
    const res = await fetch(`${API_BASE}/api/device/${mac}/refresh`, { method: 'POST' });
    if (!res.ok) throw new Error('请求失败');
    showToast('刷新指令已发送，设备将在下次唤醒时刷新', 'success');
  } catch (e) {
    showToast('发送失败: ' + e.message, 'error');
  }
}

// ── Config import / export ───────────────────────────────────

function exportConfig() {
  const data = collectFormData();
  if (!data.mac) { showToast('请先加载配置', 'error'); return; }
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `inksight-config-${data.mac.replace(/:/g, '')}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('配置已导出', 'success');
}

function importConfig(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (data.mac) document.getElementById('macIn').value = data.mac;
      // Convert to the format fillForm expects
      const cfg = {
        nickname: data.nickname || '',
        modes: data.modes || [],
        refresh_strategy: data.refreshStrategy || data.refresh_strategy || 'random',
        language: data.language || 'zh',
        content_tone: data.contentTone || data.content_tone || 'neutral',
        character_tones: data.characterTones || data.character_tones || [],
        city: data.city || '杭州',
        llm_provider: data.llmProvider || data.llm_provider || 'deepseek',
        llm_model: data.llmModel || data.llm_model || 'deepseek-chat',
        refresh_interval: data.refreshInterval || data.refresh_interval || 60,
        countdownEvents: data.countdownEvents || [],
        time_slot_rules: data.timeSlotRules || data.time_slot_rules || [],
      };
      fillForm(cfg);
      document.getElementById('configForm').style.display = 'block';
      showToast('配置已导入，检查后点击保存', 'success');
    } catch (err) {
      showToast('JSON 格式无效: ' + err.message, 'error');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// ── Config preview modal ─────────────────────────────────────

function openPreviewModal() {
  const data = collectFormData();
  if (data.modes.length === 0) { showToast('请至少选择一个模式', 'error'); return; }

  const selectDiv = document.getElementById('previewModeSelect');
  selectDiv.innerHTML = '<div class="cg">' + data.modes.map(m =>
    `<span class="ch" onclick="previewMode('${m}', this)" style="cursor:pointer">${m}</span>`
  ).join('') + '</div>';

  document.getElementById('previewImg').src = '';
  document.getElementById('previewStatus').textContent = '选择一个模式开始预览';
  document.getElementById('previewModal').classList.add('active');
}

function closePreviewModal() {
  document.getElementById('previewModal').classList.remove('active');
}

async function previewMode(mode, el) {
  // Open the preview modal if not already visible
  const modal = document.getElementById('previewModal');
  if (!modal.classList.contains('active')) {
    document.getElementById('previewModeSelect').innerHTML = '';
    document.getElementById('previewImg').src = '';
    modal.classList.add('active');
  }

  if (el) {
    el.closest('.cg').querySelectorAll('.ch').forEach(c => c.classList.remove('sel'));
    el.classList.add('sel');
  }
  document.getElementById('previewStatus').textContent = '渲染中...';
  const img = document.getElementById('previewImg');
  try {
    const start = performance.now();
    const res = await fetch(`${API_BASE}/api/preview?persona=${mode}&v=3.30`);
    const elapsed = Math.round(performance.now() - start);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const blob = await res.blob();
    img.src = URL.createObjectURL(blob);
    document.getElementById('previewStatus').textContent = `${mode} · ${elapsed}ms · ${(blob.size/1024).toFixed(1)}KB`;
  } catch (e) {
    document.getElementById('previewStatus').textContent = '渲染失败: ' + e.message;
  }
}

// ── Countdown events ─────────────────────────────────────────

function addCountdownEvent(name='', date='', type='countdown') {
  const container = document.getElementById('countdownEvents');
  if (container.children.length >= 10) { showToast('最多添加 10 个事件', 'error'); return; }
  const row = document.createElement('div');
  row.style.cssText = 'display:flex;gap:6px;align-items:center;margin-bottom:6px';
  row.innerHTML = `
    <input type="text" class="inp cd-name" placeholder="事件名称" value="${name}" style="flex:2">
    <input type="date" class="inp cd-date" value="${date}" style="flex:2">
    <select class="sel cd-type" style="flex:1;padding:8px"><option value="countdown" ${type==='countdown'?'selected':''}>倒计时</option><option value="countup" ${type==='countup'?'selected':''}>正计日</option></select>
    <button onclick="this.parentElement.remove()" style="padding:6px 10px;border:1px solid var(--bd);border-radius:6px;cursor:pointer;background:#fff;color:var(--red);font-size:.8rem">✕</button>
  `;
  container.appendChild(row);
}

function getCountdownEvents() {
  const events = [];
  document.querySelectorAll('#countdownEvents > div').forEach(row => {
    const name = row.querySelector('.cd-name').value.trim();
    const date = row.querySelector('.cd-date').value;
    const type = row.querySelector('.cd-type').value;
    if (name && date) events.push({ name, date, type });
  });
  return events;
}

function fillCountdownEvents(events) {
  const container = document.getElementById('countdownEvents');
  container.innerHTML = '';
  (events || []).forEach(evt => {
    addCountdownEvent(evt.name || '', evt.date || '', evt.type || 'countdown');
  });
}

// ── Custom mode management ───────────────────────────────────

const MODE_TEMPLATES = {
  quote: {
    mode_id: "MY_QUOTE",
    display_name: "我的语录",
    icon: "book",
    cacheable: true,
    description: "自定义语录模式",
    content: {
      type: "llm",
      prompt_template: "你是一位人生导师。根据以下环境信息，生成一句富有哲理的语录和作者，用 | 分隔。\n环境：{context}",
      output_format: "text_split",
      output_separator: "|",
      output_fields: ["quote", "author"],
      temperature: 0.8,
      fallback: { quote: "生活不止眼前的苟且", author: "高晓松" }
    },
    layout: {
      status_bar: { line_width: 1, dashed: false },
      body: [{ type: "centered_text", field: "quote", font: "noto_serif_light", font_size: 16, vertical_center: true }],
      footer: { label: "MY_QUOTE", attribution_template: "— {author}" }
    }
  },
  list: {
    mode_id: "MY_LIST",
    display_name: "我的列表",
    icon: "star",
    cacheable: false,
    description: "自定义列表模式",
    content: {
      type: "llm_json",
      prompt_template: "推荐 5 个今日值得关注的话题，用 JSON 输出：{{\"title\": \"标题\", \"items\": [{{\"name\": \"话题\", \"desc\": \"简述\"}}]}}\n只输出 JSON。\n环境：{context}",
      output_schema: {
        title: { type: "string", "default": "今日话题" },
        items: { type: "array", "default": [{ name: "示例话题", desc: "简要描述" }] }
      },
      temperature: 0.8,
      fallback: { title: "今日话题", items: [{ name: "暂无数据", desc: "请稍后重试" }] }
    },
    layout: {
      status_bar: { line_width: 1 },
      body: [
        { type: "spacer", height: 14 },
        { type: "text", field: "title", font: "noto_serif_bold", font_size: 16, align: "center" },
        { type: "spacer", height: 4 },
        { type: "separator", style: "solid", margin_x: 24 },
        { type: "list", field: "items", max_items: 6, item_template: "{name}", right_field: "desc", font_size: 13, margin_x: 24, numbered: true, item_spacing: 18 }
      ],
      footer: { label: "MY_LIST", attribution_template: "InkSight" }
    }
  },
  zen: {
    mode_id: "MY_ZEN",
    display_name: "极简字",
    icon: "zen",
    cacheable: true,
    description: "一个大字代表当下",
    content: {
      type: "llm",
      prompt_template: "根据当前环境，输出一个最有意境的汉字，不要其他内容。\n环境：{context}",
      output_format: "raw",
      output_fields: ["word"],
      post_process: { word: "first_char" },
      temperature: 0.9,
      fallback: { word: "悟" }
    },
    layout: {
      status_bar: { dashed: true },
      body: [{ type: "centered_text", field: "word", font: "noto_serif_regular", font_size: 48, vertical_center: true }],
      footer: { label: "MY_ZEN", attribution_template: "— ...", dashed: true }
    }
  },
  sections: {
    mode_id: "MY_SECTIONS",
    display_name: "分栏展示",
    icon: "sunny",
    cacheable: false,
    description: "多区块内容展示",
    content: {
      type: "llm_json",
      prompt_template: "你是一位生活助手。用 JSON 输出今日推荐：{{\"greeting\": \"一句问候\", \"tip\": \"一条实用建议\", \"fun_fact\": \"一个冷知识\"}}\n只输出 JSON。\n环境：{context}",
      output_schema: {
        greeting: { type: "string", "default": "美好的一天" },
        tip: { type: "string", "default": "多喝水" },
        fun_fact: { type: "string", "default": "蜜蜂可以识别人脸" }
      },
      temperature: 0.8,
      fallback: { greeting: "美好的一天", tip: "保持微笑", fun_fact: "章鱼有三颗心脏" }
    },
    layout: {
      status_bar: { line_width: 1 },
      body: [
        { type: "spacer", height: 14 },
        { type: "text", field: "greeting", font: "noto_serif_bold", font_size: 16, align: "center" },
        { type: "spacer", height: 8 },
        { type: "separator", style: "solid", margin_x: 24 },
        { type: "section", title: "今日建议", icon: "tips", children: [
          { type: "text", field: "tip", font: "noto_serif_regular", font_size: 14, align: "left", margin_x: 40 }
        ]},
        { type: "spacer", height: 4 },
        { type: "separator", style: "dashed", margin_x: 24 },
        { type: "section", title: "冷知识", icon: "book", children: [
          { type: "text", field: "fun_fact", font: "noto_serif_light", font_size: 13, align: "left", margin_x: 40 }
        ]}
      ],
      footer: { label: "MY_SECTIONS", attribution_template: "InkSight" }
    }
  }
};

let _editingModeId = null;

async function refreshModeList() {
  const container = document.getElementById('modeList');
  try {
    const res = await fetch(`${API_BASE}/api/modes`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const modes = data.modes || [];

    if (modes.length === 0) {
      container.innerHTML = '<div style="color:var(--gy);font-size:.85rem;text-align:center;padding:16px">暂无模式</div>';
      return;
    }

    const srcLabels = { builtin: '内置', builtin_json: 'JSON内置', custom: '自定义' };
    const srcClasses = { builtin: 'mode-src-builtin', builtin_json: 'mode-src-builtin_json', custom: 'mode-src-custom' };

    container.innerHTML = modes.map(m => {
      const srcLabel = srcLabels[m.source] || m.source;
      const srcClass = srcClasses[m.source] || 'mode-src-builtin';
      const isCustom = m.source === 'custom';
      return `<div class="mode-item">
        <div class="mode-meta">
          <strong>${m.mode_id}</strong>
          <span class="mode-src ${srcClass}">${srcLabel}</span>
          <span style="color:var(--gy);font-size:.8rem;margin-left:6px">${m.display_name}</span>
          ${m.description ? `<p>${m.description}</p>` : ''}
        </div>
        <div class="mode-actions">
          ${isCustom ? `<button onclick="editCustomMode('${m.mode_id}')">编辑</button>` : ''}
          ${isCustom ? `<button class="btn-del" onclick="deleteCustomMode('${m.mode_id}')">删除</button>` : ''}
          <button onclick="previewMode('${m.mode_id}')">预览</button>
        </div>
      </div>`;
    }).join('');

    // Also update the mode chips in the config form with any custom modes
    updateModeChips(modes);
  } catch (e) {
    container.innerHTML = `<div style="color:var(--red);font-size:.85rem;text-align:center;padding:16px">加载失败: ${e.message}</div>`;
  }
}

function updateModeChips(modes) {
  const container = document.getElementById('modes');
  const existing = new Set();
  container.querySelectorAll('.ch').forEach(el => existing.add(el.dataset.m));

  modes.forEach(m => {
    if (!existing.has(m.mode_id)) {
      const chip = document.createElement('span');
      chip.className = 'ch';
      chip.dataset.m = m.mode_id;
      chip.dataset.tip = m.description || '';
      chip.onclick = function() { tc(this); };
      chip.textContent = `${m.mode_id} ${m.display_name}`;
      container.appendChild(chip);
    }
  });
}

function openModeEditor(modeId) {
  _editingModeId = modeId || null;
  document.getElementById('modeEditorTitle').textContent = modeId ? `编辑模式: ${modeId}` : '新建自定义模式';
  document.getElementById('modeJsonError').textContent = '';

  if (!modeId) {
    document.getElementById('modeJsonIn').value = JSON.stringify(MODE_TEMPLATES.quote, null, 2);
  }

  document.getElementById('modeEditorModal').classList.add('active');
}

function closeModeEditor() {
  document.getElementById('modeEditorModal').classList.remove('active');
  _editingModeId = null;
}

async function editCustomMode(modeId) {
  try {
    const res = await fetch(`${API_BASE}/api/modes/custom/${modeId}`);
    if (!res.ok) throw new Error('获取失败');
    const def = await res.json();
    _editingModeId = modeId;
    document.getElementById('modeEditorTitle').textContent = `编辑模式: ${modeId}`;
    document.getElementById('modeJsonIn').value = JSON.stringify(def, null, 2);
    document.getElementById('modeJsonError').textContent = '';
    document.getElementById('modeEditorModal').classList.add('active');
  } catch (e) {
    showToast('加载失败: ' + e.message, 'error');
  }
}

function fillModeTemplate(key) {
  const tpl = MODE_TEMPLATES[key];
  if (tpl) {
    document.getElementById('modeJsonIn').value = JSON.stringify(tpl, null, 2);
    document.getElementById('modeJsonError').textContent = '';
  }
}

function validateModeJson() {
  const textarea = document.getElementById('modeJsonIn');
  const errorDiv = document.getElementById('modeJsonError');
  try {
    const obj = JSON.parse(textarea.value);
    if (!obj.mode_id) { errorDiv.textContent = 'mode_id 必填'; return false; }
    if (!obj.content || !obj.content.type) { errorDiv.textContent = 'content.type 必填'; return false; }
    if (!obj.layout || !obj.layout.body || !obj.layout.body.length) { errorDiv.textContent = 'layout.body 必须包含至少一个块'; return false; }
    errorDiv.textContent = '';
    return true;
  } catch (e) {
    errorDiv.textContent = 'JSON 格式错误: ' + e.message;
    return false;
  }
}

async function saveModeDefinition() {
  if (!validateModeJson()) { showToast('请修正 JSON 错误', 'error'); return; }

  try {
    const def = JSON.parse(document.getElementById('modeJsonIn').value);
    const res = await fetch(`${API_BASE}/api/modes/custom`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(def)
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || '保存失败');
    showToast(`模式 ${data.mode_id} 保存成功`, 'success');
    closeModeEditor();
    refreshModeList();
  } catch (e) {
    showToast('保存失败: ' + e.message, 'error');
  }
}

async function deleteCustomMode(modeId) {
  const ok = await showConfirm(`确定删除自定义模式 "${modeId}" 吗？此操作不可恢复。`);
  if (!ok) return;

  try {
    const res = await fetch(`${API_BASE}/api/modes/custom/${modeId}`, { method: 'DELETE' });
    if (!res.ok) throw new Error('删除失败');
    showToast(`模式 ${modeId} 已删除`, 'success');
    refreshModeList();
  } catch (e) {
    showToast('删除失败: ' + e.message, 'error');
  }
}

async function previewCustomMode() {
  if (!validateModeJson()) { showToast('请修正 JSON 错误', 'error'); return; }

  try {
    const def = JSON.parse(document.getElementById('modeJsonIn').value);
    // Save temporarily, then preview
    const saveRes = await fetch(`${API_BASE}/api/modes/custom`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(def)
    });
    if (!saveRes.ok) {
      const err = await saveRes.json();
      throw new Error(err.error || '保存失败');
    }

    const modeId = def.mode_id.toUpperCase();
    const img = document.getElementById('previewImg');
    document.getElementById('previewStatus').textContent = '渲染中...';
    document.getElementById('previewModal').classList.add('active');

    const start = performance.now();
    const res = await fetch(`${API_BASE}/api/preview?persona=${modeId}&v=3.30`);
    const elapsed = Math.round(performance.now() - start);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const blob = await res.blob();
    img.src = URL.createObjectURL(blob);
    document.getElementById('previewStatus').textContent = `${modeId} · ${elapsed}ms · ${(blob.size/1024).toFixed(1)}KB`;
    document.getElementById('previewModeSelect').innerHTML = '';
  } catch (e) {
    showToast('预览失败: ' + e.message, 'error');
  }
}

// ── Initialize ───────────────────────────────────────────────
updateModels();
refreshModeList();

const urlParams = new URLSearchParams(window.location.search);
const macParam = urlParams.get('mac');
if (macParam) {
  document.getElementById('macIn').value = macParam;
  loadConfig();
}
</script>
</body>
</html>

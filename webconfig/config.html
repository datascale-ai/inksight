<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>InkSight é…ç½®ç®¡ç†</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--bk:#1a1a1a;--gy:#888;--bg:#fafaf7;--bd:#d4d4cf;--green:#16a34a;--red:#dc2626}
body{font-family:'Inter',-apple-system,sans-serif;background:linear-gradient(135deg,#f5f5f0,#e8e8e0);color:var(--bk);line-height:1.6;min-height:100vh;padding:24px}
.container{max-width:800px;margin:0 auto}
.card{background:#fff;border-radius:20px;box-shadow:0 8px 40px rgba(0,0,0,.08);padding:32px;margin-bottom:20px}
h1{font-size:1.8rem;margin-bottom:8px}
.subtitle{color:var(--gy);font-size:.9rem;margin-bottom:24px}
.inp,.sel{width:100%;padding:10px 12px;font-size:.9rem;border:1px solid var(--bd);border-radius:8px;background:var(--bg);outline:none}
.inp:focus,.sel:focus{border-color:var(--bk)}
.fg{margin-bottom:16px}
.lbl{display:block;font-size:.85rem;font-weight:600;margin-bottom:6px}
.btn{padding:12px 24px;font-size:.9rem;font-weight:600;color:#fff;background:var(--bk);border:none;border-radius:10px;cursor:pointer}
.btn:hover{background:#333}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn-secondary{background:#6b7280}
.btn-secondary:hover{background:#4b5563}
.btn-outline{background:#fff;color:var(--bk);border:1px solid var(--bd)}
.btn-outline:hover{background:var(--bg)}
.cg{display:flex;flex-wrap:wrap;gap:8px}
.ch{padding:6px 12px;font-size:.8rem;border:1px solid var(--bd);border-radius:18px;cursor:pointer;background:#fff;color:var(--gy);position:relative}
.ch:hover{border-color:var(--bk);color:var(--bk)}
.ch.sel{background:var(--bk);color:#fff;border-color:var(--bk)}
.ch[data-tip]:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--bk);color:#fff;padding:4px 10px;border-radius:6px;font-size:.7rem;white-space:nowrap;z-index:10;pointer-events:none}
.ch[data-tip]:hover::before{content:'';position:absolute;bottom:calc(100% + 2px);left:50%;transform:translateX(-50%);border:4px solid transparent;border-top-color:var(--bk);z-index:10}
.pg{display:flex;gap:8px;flex-wrap:wrap}
.pi{flex:1;padding:8px;text-align:center;font-size:.8rem;border:1px solid var(--bd);border-radius:8px;cursor:pointer;background:#fff;color:var(--gy);min-width:70px}
.pi:hover{background:var(--bg)}
.pi.sel{background:var(--bk);color:#fff}
.hist-item{padding:12px;border:1px solid var(--bd);border-radius:8px;margin-bottom:8px;cursor:pointer;background:#fff}
.hist-item:hover{border-color:var(--bk);background:var(--bg)}
.hist-item.active{border-color:var(--bk);background:var(--bg)}
.hist-meta{font-size:.75rem;color:var(--gy);margin-bottom:6px}
.hist-content{font-size:.85rem;line-height:1.6}
.hist-actions{margin-top:8px;display:flex;gap:8px}
.hist-actions button{padding:4px 12px;font-size:.75rem;border:1px solid var(--bd);border-radius:6px;cursor:pointer;background:#fff}
.hist-actions button:hover{background:var(--bg)}
.tc{margin-bottom:6px}
.tcl{font-size:.68rem;color:var(--gy);margin-bottom:3px;font-weight:500}
.mode-fold-toggle{margin-top:8px;padding:6px 12px;font-size:.75rem;border:1px solid var(--bd);border-radius:8px;background:#fff;color:var(--gy);cursor:pointer}
.mode-fold-toggle:hover{border-color:var(--bk);color:var(--bk);background:var(--bg)}
.mode-thumb{margin-top:10px;border:1px solid var(--bd);border-radius:10px;padding:10px;background:var(--bg)}
.mode-thumb-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.mode-thumb-title{font-size:.78rem;font-weight:600}
.mode-thumb-desc{font-size:.7rem;color:var(--gy)}
.mode-thumb-img{width:100%;max-height:140px;object-fit:contain;border:1px solid var(--bd);border-radius:6px;background:#fff}

/* Toast notifications */
#toastContainer{position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{padding:12px 20px;border-radius:10px;font-size:.85rem;font-weight:500;box-shadow:0 4px 20px rgba(0,0,0,.12);transform:translateX(120%);transition:transform .3s ease,opacity .3s ease;opacity:0;pointer-events:auto;max-width:360px}
.toast.show{transform:translateX(0);opacity:1}
.toast-success{background:#dcfce7;color:#15803d;border:1px solid #bbf7d0}
.toast-error{background:#fef2f2;color:#dc2626;border:1px solid #fecaca}
.toast-info{background:#dbeafe;color:#1e40af;border:1px solid #bfdbfe}

/* Time slot editor */
.ts-row{display:flex;gap:6px;align-items:center;margin-bottom:6px;flex-wrap:wrap}
.ts-row .inp,.ts-row .sel{width:auto;flex:none}
.ts-modes{display:flex;flex-wrap:wrap;gap:4px;flex:1;min-width:200px}
.ts-modes .ch{padding:3px 8px;font-size:.72rem}

/* Preview modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
.modal-overlay.active{opacity:1;pointer-events:auto}
.modal-content{background:#fff;border-radius:16px;padding:24px;max-width:520px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.modal-content h3{font-size:1.1rem;margin-bottom:12px}
.modal-close{float:right;border:none;background:none;font-size:1.2rem;cursor:pointer;color:var(--gy)}
/* Keep preview above mode editor when both are open */
#modeEditorModal{z-index:1000}
#previewModal{z-index:1010}

/* Confirm dialog */
.confirm-bar{display:flex;gap:8px;margin-top:12px;justify-content:flex-end}
.confirm-bar .btn{padding:8px 18px;font-size:.82rem}

/* Strategy description */
.strategy-desc{font-size:.72rem;color:var(--gy);margin-top:6px;min-height:1.2em}

/* Custom mode editor */
.mode-list{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
.mode-item{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border:1px solid var(--bd);border-radius:10px;background:#fff}
.mode-item:hover{border-color:var(--bk);background:var(--bg)}
.mode-meta{flex:1;min-width:0}
.mode-meta strong{font-size:.9rem}
.mode-meta .mode-src{font-size:.68rem;padding:2px 6px;border-radius:4px;margin-left:6px}
.mode-src-builtin{background:#dbeafe;color:#1e40af}
.mode-src-builtin_json{background:#e0e7ff;color:#4338ca}
.mode-src-custom{background:#dcfce7;color:#15803d}
.mode-meta p{font-size:.75rem;color:var(--gy);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.mode-actions{display:flex;gap:6px;flex-shrink:0;margin-left:12px}
.mode-actions button{padding:4px 10px;font-size:.75rem;border:1px solid var(--bd);border-radius:6px;cursor:pointer;background:#fff}
.mode-actions button:hover{background:var(--bg)}
.mode-actions .btn-del{color:var(--red);border-color:#fecaca}
.mode-actions .btn-del:hover{background:#fef2f2}
.json-editor{width:100%;min-height:260px;font-family:'Menlo','Monaco','Courier New',monospace;font-size:.8rem;padding:12px;border:1px solid var(--bd);border-radius:10px;background:#fafaf7;resize:vertical;line-height:1.5;tab-size:2}
.json-editor:focus{border-color:var(--bk);outline:none}
.json-error{font-size:.75rem;color:var(--red);margin-top:4px;min-height:1.1em}

/* Editor tabs & AI generate panel */
.editor-tabs{display:flex;border-bottom:1px solid var(--bd);margin-bottom:12px}
.editor-tab{padding:8px 16px;font-size:.85rem;cursor:pointer;border:none;border-bottom:2px solid transparent;color:var(--gy);background:none}
.editor-tab:hover{color:var(--bk)}
.editor-tab.active{color:var(--bk);border-bottom-color:var(--bk);font-weight:600}
.ai-gen-panel,.manual-panel{display:none}
.ai-gen-panel.active,.manual-panel.active{display:block}
.ai-desc-input{width:100%;min-height:100px;padding:12px;border:1px solid var(--bd);border-radius:10px;background:var(--bg);font-size:.85rem;resize:vertical;font-family:inherit;line-height:1.5}
.ai-desc-input:focus{border-color:var(--bk);outline:none}
.ai-desc-input::placeholder{color:#bbb}
.ai-img-upload{border:2px dashed var(--bd);border-radius:10px;padding:20px;text-align:center;cursor:pointer;color:var(--gy);font-size:.82rem;transition:border-color .2s}
.ai-img-upload:hover{border-color:var(--bk)}
.ai-img-upload.has-image{border-style:solid;padding:8px}
.ai-img-preview{max-width:100%;max-height:150px;border-radius:6px;margin-top:8px}
.ai-gen-btn{width:100%;padding:12px;font-size:.9rem;font-weight:600;color:#fff;background:var(--bk);border:none;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
.ai-gen-btn:hover{background:#333}
.ai-gen-btn:disabled{opacity:.6;cursor:not-allowed}
.ai-gen-btn .spinner{width:16px;height:16px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:aispin .6s linear infinite;display:none}
.ai-gen-btn.loading .spinner{display:inline-block}
.ai-gen-btn.loading .btn-text{display:none}
@keyframes aispin{to{transform:rotate(360deg)}}
.ai-gen-result{margin-top:12px;padding:12px;border:1px solid #bbf7d0;border-radius:10px;background:#f0fdf4;display:none}
.ai-gen-result.show{display:block}

.tpl-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;margin-bottom:12px}
.tpl-card{padding:10px;border:1px solid var(--bd);border-radius:10px;cursor:pointer;background:#fff;text-align:center}
.tpl-card:hover{border-color:var(--bk);background:var(--bg)}
.tpl-card strong{font-size:.85rem;display:block;margin-bottom:4px}
.tpl-card span{font-size:.7rem;color:var(--gy)}

.wizard-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9999}
.wizard-card{background:#fff;border-radius:16px;padding:32px;max-width:440px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.15)}
.wizard-header{text-align:center;margin-bottom:20px}
.wizard-header h2{font-size:1.3rem;margin:0 0 4px}
.wizard-header p{color:#888;font-size:.85rem;margin:0}
.wizard-steps{display:flex;justify-content:center;gap:16px;margin-bottom:24px}
.wiz-step{font-size:.75rem;color:#aaa;font-weight:500}
.wiz-step.active{color:#1a1a1a;font-weight:600}
.wiz-step.done{color:#22c55e}
.wiz-field{margin-bottom:16px}
.wiz-field label{display:block;font-size:.82rem;font-weight:500;margin-bottom:6px;color:#333}
.wiz-input{width:100%;padding:10px 12px;border:1px solid #d4d4cf;border-radius:8px;font-size:.85rem;background:#fafaf7}
.wiz-input:focus{border-color:#1a1a1a;outline:none}
.wiz-hint{font-size:.72rem;color:#999;margin-top:4px}
.wiz-btn{display:block;width:100%;padding:12px;font-size:.9rem;font-weight:600;color:#fff;background:#1a1a1a;border:none;border-radius:10px;cursor:pointer}
.wiz-btn:hover{background:#333}
.wiz-btn-secondary{background:#f5f5f0;color:#1a1a1a;flex:1}
.wiz-btn-secondary:hover{background:#e8e8e0}
.wiz-presets{display:flex;flex-direction:column;gap:8px}
.wiz-preset{padding:12px;border:1px solid #d4d4cf;border-radius:8px;cursor:pointer;font-size:.82rem}
.wiz-preset:hover{border-color:#1a1a1a}
.wiz-preset.selected{border-color:#1a1a1a;background:#f5f5f0}
.wiz-preset strong{font-size:.85rem}
.wiz-preset span{color:#888;font-size:.75rem}
</style>
</head>
<body>
<!-- Setup Wizard Modal -->
<div id="setupWizard" class="wizard-overlay" style="display:none">
  <div class="wizard-card">
    <div class="wizard-header">
      <h2>ğŸ‰ æ¬¢è¿ä½¿ç”¨ InkSight</h2>
      <p>è®©æˆ‘ä»¬å¿«é€Ÿå®Œæˆåˆå§‹é…ç½®</p>
    </div>
    <div class="wizard-steps">
      <span class="wiz-step active" id="ws1">1. AI æ¨¡å‹</span>
      <span class="wiz-step" id="ws2">2. å†…å®¹æ¨¡å¼</span>
      <span class="wiz-step" id="ws3">3. åŸºæœ¬è®¾ç½®</span>
    </div>
    
    <!-- Step 1: LLM Provider -->
    <div id="wizStep1" class="wiz-panel">
      <div class="wiz-field">
        <label>AI æœåŠ¡å•†</label>
        <select id="wizLlmProvider" class="wiz-input">
          <option value="deepseek">DeepSeek</option>
          <option value="aliyun">é˜¿é‡Œç™¾ç‚¼</option>
          <option value="moonshot">æœˆä¹‹æš—é¢</option>
        </select>
      </div>
      <div class="wiz-field">
        <label>API Key</label>
        <input type="password" id="wizApiKey" class="wiz-input" placeholder="è¾“å…¥ä½ çš„ API Key">
        <div class="wiz-hint">å‰å¾€å¯¹åº”æœåŠ¡å•†å®˜ç½‘è·å– API Key</div>
      </div>
      <button class="wiz-btn" onclick="wizNext(2)">ä¸‹ä¸€æ­¥</button>
    </div>
    
    <!-- Step 2: Mode Selection -->
    <div id="wizStep2" class="wiz-panel" style="display:none">
      <div class="wiz-field">
        <label>é€‰æ‹©ä¸€ä¸ªé¢„è®¾æ–¹æ¡ˆï¼Œç¨åå¯ä»¥ä¿®æ”¹</label>
        <div class="wiz-presets">
          <div class="wiz-preset selected" data-preset="recommended" onclick="selectWizPreset(this)">
            <strong>æ¨èæ¨¡å¼</strong><br>
            <span>DAILY + WEATHER + ZEN + STOIC + BRIEFING<br>æœ€å—æ¬¢è¿çš„å…¨èƒ½ç»„åˆ</span>
          </div>
          <div class="wiz-preset" data-preset="literary" onclick="selectWizPreset(this)">
            <strong>æ–‡è‰ºæ¨¡å¼</strong><br>
            <span>ZEN + POETRY + ARTWALL + ALMANAC<br>è¯—è¯ç”»ä½œä¸èŠ‚æ°”é™ªä¼´</span>
          </div>
          <div class="wiz-preset" data-preset="efficiency" onclick="selectWizPreset(this)">
            <strong>æ•ˆç‡æ¨¡å¼</strong><br>
            <span>BRIEFING + WEATHER + COUNTDOWN + DAILY<br>å·¥ä½œæ¡Œé¢å¸¸ç”¨ä¿¡æ¯</span>
          </div>
          <div class="wiz-preset" data-preset="minimal" onclick="selectWizPreset(this)">
            <strong>æç®€æ¨¡å¼</strong><br>
            <span>STOIC + ZEN<br>ä¸€å­—ä¸€å¥ï¼Œå®‰é™é™ªä¼´</span>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="wiz-btn wiz-btn-secondary" onclick="wizBack(1)">ä¸Šä¸€æ­¥</button>
        <button class="wiz-btn" onclick="wizNext(3)">ä¸‹ä¸€æ­¥</button>
      </div>
    </div>
    
    <!-- Step 3: Basic Settings -->
    <div id="wizStep3" class="wiz-panel" style="display:none">
      <div class="wiz-field">
        <label>åˆ·æ–°é—´éš”</label>
        <select id="wizRefresh" class="wiz-input">
          <option value="60">1 å°æ—¶</option>
          <option value="120">2 å°æ—¶</option>
          <option value="240">4 å°æ—¶</option>
        </select>
      </div>
      <div class="wiz-field">
        <label>æ‰€åœ¨åŸå¸‚</label>
        <input type="text" id="wizCity" class="wiz-input" value="æ­å·" placeholder="è¾“å…¥ä½ çš„åŸå¸‚å">
      </div>
      <div style="display:flex;gap:8px">
        <button class="wiz-btn wiz-btn-secondary" onclick="wizBack(2)">ä¸Šä¸€æ­¥</button>
        <button class="wiz-btn" onclick="wizFinish()">å®Œæˆé…ç½®</button>
      </div>
    </div>
  </div>
</div>

<div id="toastContainer"></div>

<div id="previewModal" class="modal-overlay" onclick="if(event.target===this)closePreviewModal()">
<div class="modal-content">
<button class="modal-close" onclick="closePreviewModal()">&times;</button>
<h3>é…ç½®é¢„è§ˆ</h3>
<div id="previewModeSelect" style="margin-bottom:12px"></div>
<div style="text-align:center">
<img id="previewImg" style="max-width:100%;border:2px solid #d4d4d4;border-radius:6px;background:#f5f5f5" alt="Preview">
<div id="previewStatus" style="font-size:.75rem;color:var(--gy);margin-top:8px"></div>
</div>
</div>
</div>

<div id="confirmModal" class="modal-overlay" onclick="if(event.target===this)closeConfirm(false)">
<div class="modal-content" style="max-width:400px">
<p id="confirmMsg" style="font-size:.9rem;line-height:1.6"></p>
<div class="confirm-bar">
<button class="btn btn-outline" onclick="closeConfirm(false)">å–æ¶ˆ</button>
<button class="btn" onclick="closeConfirm(true)">ç¡®å®š</button>
</div>
</div>
</div>

<div class="container">
<div class="card">
<h1>InkSight é…ç½®ç®¡ç†</h1>
<p class="subtitle">åœ¨çº¿ä¿®æ”¹è®¾å¤‡é…ç½®ï¼Œæ— éœ€é‡æ–°è¿æ¥çƒ­ç‚¹</p>

<div class="fg">
<label class="lbl">è®¾å¤‡ MAC åœ°å€</label>
<input type="text" class="inp" id="macIn" placeholder="ä¾‹å¦‚: 88:56:A6:7B:C7:0C">
<div id="deviceList" style="margin-top:6px"></div>
<div style="font-size:.75rem;color:var(--gy);margin-top:4px">åœ¨è®¾å¤‡å±å¹•åº•éƒ¨æˆ–åˆå§‹é…ç½®é¡µé¢å¯ä»¥æ‰¾åˆ°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ URL å‚æ•°ä¼ é€’</div>
</div>

<div style="display:flex;gap:8px;flex-wrap:wrap">
<button class="btn" onclick="loadConfig()" id="loadBtn" style="flex:1;min-width:120px">åŠ è½½å½“å‰é…ç½®</button>
<button class="btn btn-secondary" onclick="loadHistory()" id="historyBtn" style="flex:1;min-width:120px">æŸ¥çœ‹å†å²é…ç½®</button>
<button class="btn" onclick="triggerRefresh()" style="flex:1;min-width:120px;background:var(--green)">ç«‹å³åˆ·æ–°</button>
</div>

<div id="historyList" style="display:none;margin-top:16px"></div>
</div>

<div id="configForm" style="display:none">
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
<h2 style="font-size:1.3rem">è®¾å¤‡é…ç½®</h2>
<div style="display:flex;gap:6px">
<button class="btn btn-outline" onclick="exportConfig()" style="padding:6px 12px;font-size:.75rem">å¯¼å‡º JSON</button>
<button class="btn btn-outline" onclick="document.getElementById('importFile').click()" style="padding:6px 12px;font-size:.75rem">å¯¼å…¥ JSON</button>
<input type="file" id="importFile" accept=".json" style="display:none" onchange="importConfig(event)">
</div>
</div>

<div class="fg">
<label class="lbl">æ˜µç§°</label>
<input type="text" class="inp" id="nickname" placeholder="å¯é€‰">
</div>

<div class="fg">
<label class="lbl">å±å¹•å°ºå¯¸</label>
<div class="pg" id="screenSize">
<span class="pi sel" data-v="400x300" onclick="ps(this)">4.2" (400Ã—300)</span>
<span class="pi" data-v="296x128" onclick="ps(this)">2.9" (296Ã—128)</span>
<span class="pi" data-v="648x480" onclick="ps(this)">5.83" (648Ã—480)</span>
<span class="pi" data-v="800x480" onclick="ps(this)">7.5" (800Ã—480)</span>
</div>
</div>

<div class="fg">
<label class="lbl">å†…å®¹æ¨¡å¼ï¼ˆå¤šé€‰ï¼‰</label>
<div id="modes">
<div class="tc">
<div class="tcl">æ¨èæ ¸å¿ƒï¼ˆ10ï¼‰</div>
<div class="cg" id="modesCore">
<span class="ch" data-m="DAILY" data-tip="è¯­å½•ã€ä¹¦ç±æ¨èã€å†·çŸ¥è¯†çš„ç»¼åˆæ—¥æŠ¥" onclick="tc(this)">DAILY æ¯æ—¥</span>
<span class="ch" data-m="WEATHER" data-tip="å®æ—¶å¤©æ°”å’Œæœªæ¥è¶‹åŠ¿çœ‹æ¿" onclick="tc(this)">WEATHER å¤©æ°”</span>
<span class="ch" data-m="ZEN" data-tip="ä¸€ä¸ªå¤§å­—è¡¨è¾¾å½“ä¸‹å¿ƒå¢ƒ" onclick="tc(this)">ZEN ç¦…æ„</span>
<span class="ch" data-m="BRIEFING" data-tip="ç§‘æŠ€çƒ­æ¦œ + AI æ´å¯Ÿç®€æŠ¥" onclick="tc(this)">BRIEFING ç®€æŠ¥</span>
<span class="ch" data-m="STOIC" data-tip="æ¯æ—¥ä¸€å¥å“²å­¦ç®´è¨€" onclick="tc(this)">STOIC æ–¯å¤šè‘›</span>
<span class="ch" data-m="POETRY" data-tip="å¤è¯—è¯ä¸ç®€çŸ­æ³¨è§£" onclick="tc(this)">POETRY è¯—è¯</span>
<span class="ch" data-m="ARTWALL" data-tip="æ ¹æ®æ—¶ä»¤ç”Ÿæˆé»‘ç™½è‰ºæœ¯ç”»" onclick="tc(this)">ARTWALL ç”»å»Š</span>
<span class="ch" data-m="ALMANAC" data-tip="å†œå†ã€èŠ‚æ°”ã€å®œå¿Œä¿¡æ¯" onclick="tc(this)">ALMANAC è€é»„å†</span>
<span class="ch" data-m="RECIPE" data-tip="æŒ‰æ—¶æ®µæ¨èä¸‰é¤æ–¹æ¡ˆ" onclick="tc(this)">RECIPE é£Ÿè°±</span>
<span class="ch" data-m="COUNTDOWN" data-tip="é‡è¦æ—¥ç¨‹å€’è®¡æ—¶/æ­£è®¡æ—¶" onclick="tc(this)">COUNTDOWN å€’è®¡æ—¶</span>
</div>
</div>
<div class="tc">
<div class="tcl">å·¥å…·æ¨¡å¼</div>
<div class="cg" id="modesTools">
<span class="ch" data-m="MEMO" data-tip="å±•ç¤ºè‡ªå®šä¹‰ä¾¿ç­¾æ–‡å­—" onclick="tc(this)">MEMO ä¾¿ç­¾</span>
<span class="ch" data-m="HABIT" data-tip="æ¯æ—¥ä¹ æƒ¯å®Œæˆè¿›åº¦" onclick="tc(this)">HABIT æ‰“å¡</span>
</div>
</div>
<button type="button" class="mode-fold-toggle" id="modesMoreToggle" onclick="toggleMoreModes()">å±•å¼€æ›´å¤šæ¨¡å¼</button>
<div class="tc" id="modesMoreWrap" style="display:none">
<div class="tcl">æ›´å¤šæ¨¡å¼</div>
<div class="cg" id="modesMore">
<span class="ch" data-m="ROAST" data-tip="è½»æ¾å¹½é»˜çš„åæ§½é£æ ¼å†…å®¹" onclick="tc(this)">ROAST æ¯’èˆŒ</span>
<span class="ch" data-m="FITNESS" data-tip="å±…å®¶å¥èº«åŠ¨ä½œä¸å»ºè®®" onclick="tc(this)">FITNESS å¥èº«</span>
<span class="ch" data-m="LETTER" data-tip="æ¥è‡ªä¸åŒæ—¶ç©ºçš„ä¸€å°æ…¢ä¿¡" onclick="tc(this)">LETTER æ…¢ä¿¡</span>
<span class="ch" data-m="THISDAY" data-tip="å†å²ä¸Šçš„ä»Šå¤©é‡å¤§äº‹ä»¶" onclick="tc(this)">THISDAY ä»Šæ—¥å†å²</span>
<span class="ch" data-m="RIDDLE" data-tip="è°œé¢˜ä¸è„‘ç­‹æ€¥è½¬å¼¯" onclick="tc(this)">RIDDLE çŒœè°œ</span>
<span class="ch" data-m="QUESTION" data-tip="å€¼å¾—æ€è€ƒçš„å¼€æ”¾å¼é—®é¢˜" onclick="tc(this)">QUESTION æ¯æ—¥ä¸€é—®</span>
<span class="ch" data-m="BIAS" data-tip="è®¤çŸ¥åå·®ä¸å¿ƒç†æ•ˆåº”" onclick="tc(this)">BIAS è®¤çŸ¥åå·®</span>
<span class="ch" data-m="STORY" data-tip="å¯åœ¨ 30 ç§’å†…è¯»å®Œçš„å¾®æ•…äº‹" onclick="tc(this)">STORY å¾®æ•…äº‹</span>
<span class="ch" data-m="LIFEBAR" data-tip="å¹´/æœˆ/å‘¨/äººç”Ÿè¿›åº¦æ¡" onclick="tc(this)">LIFEBAR è¿›åº¦æ¡</span>
<span class="ch" data-m="CHALLENGE" data-tip="æ¯å¤©ä¸€ä¸ª 5 åˆ†é’Ÿå¾®æŒ‘æˆ˜" onclick="tc(this)">CHALLENGE å¾®æŒ‘æˆ˜</span>
</div>
</div>
<div class="mode-thumb" id="modeThumbPanel">
<div class="mode-thumb-head">
<span class="mode-thumb-title" id="modeThumbTitle">DAILY æ¯æ—¥</span>
<span class="mode-thumb-desc" id="modeThumbDesc">è¯­å½•ã€ä¹¦ç±æ¨èã€å†·çŸ¥è¯†çš„ç»¼åˆæ—¥æŠ¥</span>
</div>
<img class="mode-thumb-img" id="modeThumbImg" alt="æ¨¡å¼ç¼©ç•¥å›¾">
</div>
</div>
</div>

<div class="fg">
<label class="lbl">åˆ·æ–°ç­–ç•¥</label>
<div class="pg" id="strategy">
<div class="pi" data-v="random" onclick="selectStrategy(this)">éšæœºè½®æ¢</div>
<div class="pi" data-v="cycle" onclick="selectStrategy(this)">å¾ªç¯è½®æ¢</div>
<div class="pi" data-v="time_slot" onclick="selectStrategy(this)">æ—¶æ®µç»‘å®š</div>
<div class="pi" data-v="smart" onclick="selectStrategy(this)">æ™ºèƒ½æ¨¡å¼</div>
</div>
<div class="strategy-desc" id="strategyDesc"></div>
</div>

<div class="fg" id="timeSlotSection" style="display:none">
<label class="lbl">æ—¶æ®µè§„åˆ™</label>
<div id="timeSlotRules"></div>
<button type="button" onclick="addTimeSlotRule()" style="margin-top:8px;padding:6px 14px;font-size:.8rem;border:1px solid var(--bd);border-radius:6px;cursor:pointer;background:#fff">+ æ·»åŠ æ—¶æ®µ</button>
<div style="font-size:.7rem;color:var(--gy);margin-top:4px">ä¸ºä¸åŒæ—¶é—´æ®µé…ç½®ä¸åŒçš„å†…å®¹æ¨¡å¼ï¼Œæœªè¦†ç›–çš„æ—¶æ®µä½¿ç”¨éšæœºé€‰æ‹©</div>
</div>

<div class="fg">
<label class="lbl">è¯­è¨€åå¥½</label>
<div class="pg" id="language">
<div class="pi" data-v="zh" onclick="sp(this,'language')">ä¸­æ–‡ä¸ºä¸»</div>
<div class="pi" data-v="en" onclick="sp(this,'language')">è‹±æ–‡ä¸ºä¸»</div>
<div class="pi" data-v="mixed" onclick="sp(this,'language')">ä¸­è‹±æ··åˆ</div>
</div>
</div>

<div class="fg">
<label class="lbl">å†…å®¹è°ƒæ€§</label>
<div class="pg" id="tone">
<div class="pi" data-v="positive" onclick="sp(this,'tone')">ç§¯æé¼“åŠ±</div>
<div class="pi" data-v="neutral" onclick="sp(this,'tone')">ä¸­æ€§å…‹åˆ¶</div>
<div class="pi" data-v="deep" onclick="sp(this,'tone')">æ·±æ²‰å†…çœ</div>
<div class="pi" data-v="humor" onclick="sp(this,'tone')">è½»æ¾å¹½é»˜</div>
</div>
</div>

<div class="fg">
<label class="lbl">è§’è‰²è¯­æ°”</label>
<div class="tc"><div class="tcl">æ–‡å­¦</div><div class="cg">
<span class="ch" data-t="é²è¿…" data-tip="çŠ€åˆ©è®½åˆºï¼Œé’ˆç ­æ—¶å¼Š" onclick="tc(this)">é²è¿…</span>
<span class="ch" data-t="ç‹å°æ³¢" data-tip="é»‘è‰²å¹½é»˜ï¼Œè‡ªç”±ä¸ç¾" onclick="tc(this)">ç‹å°æ³¢</span>
<span class="ch" data-t="å¼ çˆ±ç²" data-tip="å†·å³»ç»†è…»ï¼Œæ´å¯Ÿäººæ€§" onclick="tc(this)">å¼ çˆ±ç²</span>
<span class="ch" data-t="æ‘ä¸Šæ˜¥æ ‘" data-tip="å­¤ç‹¬ç¾å­¦ï¼Œæ·¡æ·¡å¿§ä¼¤" onclick="tc(this)">æ‘ä¸Šæ˜¥æ ‘</span>
</div></div>
<div class="tc"><div class="tcl">å½±è§†</div><div class="cg">
<span class="ch" data-t="ç‹å®¶å«" data-tip="æ–‡è‰ºè…”è°ƒï¼Œæƒ…ç»ªç•™ç™½" onclick="tc(this)">ç‹å®¶å«</span>
<span class="ch" data-t="å‘¨æ˜Ÿé©°" data-tip="æ— å˜å¤´å–œå‰§ï¼Œç¬‘ä¸­å¸¦æ³ª" onclick="tc(this)">å‘¨æ˜Ÿé©°</span>
<span class="ch" data-t="ç”„å¬›" data-tip="å®«æ–—è¯æœ¯ï¼Œæ­¥æ­¥ä¸ºè¥" onclick="tc(this)">ç”„å¬›</span>
<span class="ch" data-t="ç™½å±•å ‚" data-tip="æ±Ÿæ¹–æ°”æ¯ï¼Œæç¬‘æ‹…å½“" onclick="tc(this)">ç™½å±•å ‚</span>
</div></div>
<div class="tc"><div class="tcl">å“²å­¦</div><div class="cg">
<span class="ch" data-t="è‹æ ¼æ‹‰åº•" data-tip="è¿½é—®æœ¬è´¨ï¼Œåè¯˜å¯å‘" onclick="tc(this)">è‹æ ¼æ‹‰åº•</span>
<span class="ch" data-t="åº„å­" data-tip="é€é¥è‡ªåœ¨ï¼Œä¸‡ç‰©é½åŒ" onclick="tc(this)">åº„å­</span>
<span class="ch" data-t="å°¼é‡‡" data-tip="è¶…äººæ„å¿—ï¼Œæ°¸æ’å›å½’" onclick="tc(this)">å°¼é‡‡</span>
</div></div>
<div class="tc"><div class="tcl">AI / ç§‘å¹»</div><div class="cg">
<span class="ch" data-t="JARVIS" data-tip="æ™ºèƒ½ç®¡å®¶ï¼Œä¼˜é›…é«˜æ•ˆ" onclick="tc(this)">JARVIS</span>
<span class="ch" data-t="æ™ºå­" data-tip="å†·é…·ç†æ€§ï¼Œé™ç»´æ‰“å‡»" onclick="tc(this)">æ™ºå­</span>
<span class="ch" data-t="é©¬æ–‡" data-tip="åæ‰§å‹æœºå™¨äººï¼Œå®‡å®™çº§ä¸§" onclick="tc(this)">é©¬æ–‡</span>
</div></div>
<div style="margin-top:6px">
<input type="text" class="inp" id="custTone" placeholder="æˆ–è‡ªå®šä¹‰ï¼šä¸œåŒ—å¤§çˆ·ã€å·æ™®...">
</div>
</div>

<div class="fg">
<label class="lbl">åœ°ç†ä½ç½®</label>
<input type="text" class="inp" id="city" placeholder="åŸå¸‚å">
</div>

<div class="fg">
<label class="lbl">AI æ¨¡å‹æä¾›å•†</label>
<select class="sel" id="llmProvider" onchange="updateModels()">
<option value="deepseek">Deepseek</option>
<option value="aliyun">é˜¿é‡Œç™¾ç‚¼</option>
<option value="moonshot">æœˆä¹‹æš—é¢</option>
</select>
</div>

<div class="fg">
<label class="lbl">AI æ¨¡å‹</label>
<select class="sel" id="llmModel"></select>
</div>

<div class="fg">
<label class="lbl">åˆ·æ–°é—´éš”ï¼ˆåˆ†é’Ÿï¼‰</label>
<input type="number" class="inp" id="interval" min="10" max="1440" placeholder="60">
</div>

<div class="fg" id="memoSection" style="display:none">
<label class="lbl">ä¾¿ç­¾å†…å®¹ï¼ˆMEMO æ¨¡å¼ä½¿ç”¨ï¼‰</label>
<textarea class="inp" id="memoText" rows="3" placeholder="è¾“å…¥è¦åœ¨å¢¨æ°´å±ä¸Šæ˜¾ç¤ºçš„æ–‡å­—..." style="resize:vertical;font-size:.85rem;line-height:1.5"></textarea>
<div style="font-size:.7rem;color:var(--gy);margin-top:4px">å†…å®¹å°†ä»¥å¤§å­—æ˜¾ç¤ºåœ¨å±å¹•ä¸­å¤®</div>
</div>

<div class="fg" id="countdownSection">
<label class="lbl">å€’è®¡æ—¶äº‹ä»¶ï¼ˆCOUNTDOWN æ¨¡å¼ä½¿ç”¨ï¼‰</label>
<div id="countdownEvents"></div>
<button type="button" onclick="addCountdownEvent()" style="margin-top:8px;padding:6px 14px;font-size:.8rem;border:1px solid var(--bd);border-radius:6px;cursor:pointer;background:#fff">+ æ·»åŠ äº‹ä»¶</button>
<div style="font-size:.7rem;color:var(--gy);margin-top:4px">æœ€å¤š 10 ä¸ªäº‹ä»¶ï¼Œå€’è®¡æ—¶æ˜¾ç¤ºæœ€è¿‘ 3 ä¸ª</div>
</div>

<div style="display:flex;gap:8px;flex-wrap:wrap">
<button class="btn" onclick="saveConfig()" style="flex:1">ä¿å­˜é…ç½®</button>
<button class="btn btn-outline" onclick="openPreviewModal()" style="flex:1">é¢„è§ˆæ•ˆæœ</button>
</div>

<div id="inlinePreview" style="display:none;margin-top:16px;border:1px solid var(--bd);border-radius:12px;padding:16px;background:var(--bg)">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<label class="lbl" style="margin:0">å®æ—¶é¢„è§ˆ</label>
<div class="cg" id="inlinePreviewModes" style="gap:4px"></div>
</div>
<div style="text-align:center">
<img id="inlinePreviewImg" style="max-width:100%;border:2px solid #d4d4d4;border-radius:6px;background:#f5f5f5" alt="Preview">
<div id="inlinePreviewStatus" style="font-size:.72rem;color:var(--gy);margin-top:6px"></div>
</div>
</div>
</div>
</div>

<!-- Custom mode management -->
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
<h2 style="font-size:1.3rem">è‡ªå®šä¹‰æ¨¡å¼</h2>
<div style="display:flex;gap:6px">
<button class="btn btn-outline" onclick="refreshModeList()" style="padding:6px 12px;font-size:.75rem">åˆ·æ–°åˆ—è¡¨</button>
<button class="btn" onclick="openModeEditor()" style="padding:6px 12px;font-size:.75rem">+ æ–°å»ºæ¨¡å¼</button>
</div>
</div>
<div id="modeList" class="mode-list">
<div style="color:var(--gy);font-size:.85rem;text-align:center;padding:16px">åŠ è½½ä¸­...</div>
</div>
</div>

<!-- Mode editor modal -->
<div id="modeEditorModal" class="modal-overlay" onclick="if(event.target===this)closeModeEditor()">
<div class="modal-content" style="max-width:700px">
<button class="modal-close" onclick="closeModeEditor()">&times;</button>
<h3 id="modeEditorTitle">æ–°å»ºè‡ªå®šä¹‰æ¨¡å¼</h3>

<!-- Tabs -->
<div class="editor-tabs">
  <button class="editor-tab active" onclick="switchEditorTab('ai')" id="tabAi">AI ç”Ÿæˆ</button>
  <button class="editor-tab" onclick="switchEditorTab('manual')" id="tabManual">æ‰‹åŠ¨ç¼–è¾‘</button>
</div>

<!-- AI Generate Panel -->
<div class="ai-gen-panel active" id="aiGenPanel">
  <div class="fg">
    <label class="lbl">æè¿°ä½ æƒ³è¦çš„æ¨¡å¼</label>
    <textarea class="ai-desc-input" id="aiDescInput" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³è¦ä¸€ä¸ªæ¯å¤©æ˜¾ç¤ºä¸€ä¸ªè‹±è¯­å•è¯å’Œé‡Šä¹‰çš„æ¨¡å¼ï¼Œå•è¯è¦å¤§å·å­—ä½“å±…ä¸­æ˜¾ç¤ºï¼Œä¸‹é¢æ˜¾ç¤ºä¸­æ–‡é‡Šä¹‰å’Œä¸€ä¸ªä¾‹å¥ã€‚" maxlength="2000"></textarea>
    <div style="font-size:.72rem;color:var(--gy);margin-top:4px">æ”¯æŒä¸­æ–‡æˆ–è‹±æ–‡æè¿°ï¼Œè¶Šè¯¦ç»†æ•ˆæœè¶Šå¥½ï¼ˆæœ€å¤š 2000 å­—ï¼‰</div>
  </div>

  <div class="fg">
    <label class="lbl">å‚è€ƒå›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
    <div class="ai-img-upload" id="aiImgUpload" onclick="document.getElementById('aiImgFile').click()">
      <div id="aiImgPlaceholder">ç‚¹å‡»ä¸Šä¼ å‚è€ƒå›¾ç‰‡<br><span style="font-size:.7rem">æ”¯æŒ PNG / JPGï¼Œæœ€å¤§ 4MB</span></div>
      <img id="aiImgPreview" class="ai-img-preview" style="display:none">
      <input type="file" id="aiImgFile" accept="image/png,image/jpeg,image/webp" style="display:none" onchange="handleAiImageUpload(event)">
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:4px">
      <button id="aiImgClear" style="display:none;font-size:.72rem;color:var(--red);border:none;background:none;cursor:pointer" onclick="clearAiImage()">ç§»é™¤å›¾ç‰‡</button>
    </div>
  </div>

  <button class="ai-gen-btn" id="aiGenBtn" onclick="generateModeWithAI()">
    <span class="spinner"></span>
    <span class="btn-text">AI ç”Ÿæˆæ¨¡å¼</span>
  </button>

  <div class="ai-gen-result" id="aiGenResult">
    <div style="font-size:.82rem;font-weight:600;color:#15803d;margin-bottom:6px">ç”ŸæˆæˆåŠŸï¼JSON å·²å¡«å…¥ç¼–è¾‘å™¨</div>
    <div style="font-size:.78rem;color:var(--gy)">è¯·åˆ‡æ¢åˆ°ã€Œæ‰‹åŠ¨ç¼–è¾‘ã€æ£€æŸ¥å¹¶è°ƒæ•´ï¼Œç„¶åä¿å­˜æˆ–é¢„è§ˆã€‚</div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn btn-outline" onclick="switchEditorTab('manual')" style="flex:1;padding:8px;font-size:.82rem">æŸ¥çœ‹ / ç¼–è¾‘ JSON</button>
      <button class="btn" onclick="saveModeDefinition()" style="flex:1;padding:8px;font-size:.82rem">ç›´æ¥ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- Manual Edit Panel -->
<div class="manual-panel" id="manualPanel">
  <div style="margin:12px 0">
    <label class="lbl">ä»æ¨¡æ¿å¼€å§‹</label>
    <div class="tpl-grid">
      <div class="tpl-card" onclick="fillModeTemplate('quote')"><strong>è¯­å½•æ¨¡å¼</strong><span>å±…ä¸­æ–‡æœ¬ + ä½œè€…</span></div>
      <div class="tpl-card" onclick="fillModeTemplate('list')"><strong>åˆ—è¡¨æ¨¡å¼</strong><span>æ ‡é¢˜ + é¡¹ç›®åˆ—è¡¨</span></div>
      <div class="tpl-card" onclick="fillModeTemplate('zen')"><strong>æç®€æ¨¡å¼</strong><span>å¤§å­—å±…ä¸­å•å­—</span></div>
      <div class="tpl-card" onclick="fillModeTemplate('sections')"><strong>åˆ†æ æ¨¡å¼</strong><span>å¤šåŒºå— + å›¾æ ‡</span></div>
    </div>
  </div>

  <div class="fg">
    <label class="lbl">æ¨¡å¼å®šä¹‰ (JSON)</label>
    <textarea class="json-editor" id="modeJsonIn" spellcheck="false" oninput="validateModeJson()"></textarea>
    <div class="json-error" id="modeJsonError"></div>
  </div>

  <div style="display:flex;gap:8px">
    <button class="btn" onclick="saveModeDefinition()" style="flex:1">ä¿å­˜æ¨¡å¼</button>
    <button class="btn btn-outline" onclick="previewCustomMode()" style="flex:1">é¢„è§ˆæ•ˆæœ</button>
  </div>
</div>

</div>
</div>

</div>

<script>
const API_BASE = window.location.origin;

const llmModels = {
  deepseek: [{v:'deepseek-chat',n:'DeepSeek Chat'}],
  aliyun: [{v:'qwen-max',n:'é€šä¹‰åƒé—® Max'},{v:'qwen-plus',n:'é€šä¹‰åƒé—® Plus'},{v:'qwen-turbo',n:'é€šä¹‰åƒé—® Turbo'},{v:'deepseek-v3',n:'DeepSeek V3'},{v:'kimi-2.5',n:'Kimi 2.5'},{v:'glm-4-plus',n:'æ™ºè°± GLM-4 Plus'}],
  moonshot: [{v:'moonshot-v1-8k',n:'Kimi K1.5'},{v:'moonshot-v1-32k',n:'Kimi K1.5 32K'},{v:'kimi-k2-turbo-preview',n:'Kimi K2 Turbo'}]
};

const strategyDescs = {
  random: 'ä»å·²å¯ç”¨çš„æ¨¡å¼ä¸­éšæœºé€‰å–',
  cycle: 'æŒ‰é¡ºåºå¾ªç¯åˆ‡æ¢å·²å¯ç”¨çš„æ¨¡å¼',
  time_slot: 'æ ¹æ®æ—¶é—´æ®µæ˜¾ç¤ºä¸åŒå†…å®¹æ¨¡å¼ï¼ˆéœ€é…ç½®æ—¶æ®µè§„åˆ™ï¼‰',
  smart: 'æ ¹æ®æ—¶é—´æ®µè‡ªåŠ¨åŒ¹é…æœ€ä½³æ¨¡å¼ï¼ˆæ—©é¤å»ºè®®/ç§‘æŠ€ç®€æŠ¥/è¿åŠ¨è®¡åˆ’ç­‰ï¼‰'
};

const MODE_META = {
  DAILY: { name: 'æ¯æ—¥', tip: 'è¯­å½•ã€ä¹¦ç±æ¨èã€å†·çŸ¥è¯†çš„ç»¼åˆæ—¥æŠ¥' },
  WEATHER: { name: 'å¤©æ°”', tip: 'å®æ—¶å¤©æ°”å’Œæœªæ¥è¶‹åŠ¿çœ‹æ¿' },
  ZEN: { name: 'ç¦…æ„', tip: 'ä¸€ä¸ªå¤§å­—è¡¨è¾¾å½“ä¸‹å¿ƒå¢ƒ' },
  BRIEFING: { name: 'ç®€æŠ¥', tip: 'ç§‘æŠ€çƒ­æ¦œ + AI æ´å¯Ÿç®€æŠ¥' },
  STOIC: { name: 'æ–¯å¤šè‘›', tip: 'æ¯æ—¥ä¸€å¥å“²å­¦ç®´è¨€' },
  POETRY: { name: 'è¯—è¯', tip: 'å¤è¯—è¯ä¸ç®€çŸ­æ³¨è§£' },
  ARTWALL: { name: 'ç”»å»Š', tip: 'æ ¹æ®æ—¶ä»¤ç”Ÿæˆé»‘ç™½è‰ºæœ¯ç”»' },
  ALMANAC: { name: 'è€é»„å†', tip: 'å†œå†ã€èŠ‚æ°”ã€å®œå¿Œä¿¡æ¯' },
  RECIPE: { name: 'é£Ÿè°±', tip: 'æŒ‰æ—¶æ®µæ¨èä¸‰é¤æ–¹æ¡ˆ' },
  COUNTDOWN: { name: 'å€’è®¡æ—¶', tip: 'é‡è¦æ—¥ç¨‹å€’è®¡æ—¶/æ­£è®¡æ—¶' },
  MEMO: { name: 'ä¾¿ç­¾', tip: 'å±•ç¤ºè‡ªå®šä¹‰ä¾¿ç­¾æ–‡å­—' },
  HABIT: { name: 'æ‰“å¡', tip: 'æ¯æ—¥ä¹ æƒ¯å®Œæˆè¿›åº¦' },
  ROAST: { name: 'æ¯’èˆŒ', tip: 'è½»æ¾å¹½é»˜çš„åæ§½é£æ ¼å†…å®¹' },
  FITNESS: { name: 'å¥èº«', tip: 'å±…å®¶å¥èº«åŠ¨ä½œä¸å»ºè®®' },
  LETTER: { name: 'æ…¢ä¿¡', tip: 'æ¥è‡ªä¸åŒæ—¶ç©ºçš„ä¸€å°æ…¢ä¿¡' },
  THISDAY: { name: 'ä»Šæ—¥å†å²', tip: 'å†å²ä¸Šçš„ä»Šå¤©é‡å¤§äº‹ä»¶' },
  RIDDLE: { name: 'çŒœè°œ', tip: 'è°œé¢˜ä¸è„‘ç­‹æ€¥è½¬å¼¯' },
  QUESTION: { name: 'æ¯æ—¥ä¸€é—®', tip: 'å€¼å¾—æ€è€ƒçš„å¼€æ”¾å¼é—®é¢˜' },
  BIAS: { name: 'è®¤çŸ¥åå·®', tip: 'è®¤çŸ¥åå·®ä¸å¿ƒç†æ•ˆåº”' },
  STORY: { name: 'å¾®æ•…äº‹', tip: 'å¯åœ¨ 30 ç§’å†…è¯»å®Œçš„å¾®æ•…äº‹' },
  LIFEBAR: { name: 'è¿›åº¦æ¡', tip: 'å¹´/æœˆ/å‘¨/äººç”Ÿè¿›åº¦æ¡' },
  CHALLENGE: { name: 'å¾®æŒ‘æˆ˜', tip: 'æ¯å¤©ä¸€ä¸ª 5 åˆ†é’Ÿå¾®æŒ‘æˆ˜' }
};
const CORE_MODE_IDS = ['DAILY','WEATHER','ZEN','BRIEFING','STOIC','POETRY','ARTWALL','ALMANAC','RECIPE','COUNTDOWN'];
const TOOL_MODE_IDS = ['MEMO','HABIT'];
const ALL_MODES = [...new Set([...CORE_MODE_IDS, ...TOOL_MODE_IDS, ...Object.keys(MODE_META)])];

function getModeMeta(modeId) {
  return MODE_META[modeId] || { name: modeId, tip: '' };
}
function getModeChipLabel(modeId) {
  const meta = getModeMeta(modeId);
  return `${modeId} ${meta.name}`;
}
function makeModeChip(modeId, label = '', tip = '') {
  const meta = getModeMeta(modeId);
  const chip = document.createElement('span');
  chip.className = 'ch';
  chip.dataset.m = modeId;
  chip.dataset.tip = tip || meta.tip || '';
  chip.onclick = function() { tc(this); };
  chip.textContent = label || getModeChipLabel(modeId);
  return chip;
}
function toggleMoreModes(forceOpen) {
  const wrap = document.getElementById('modesMoreWrap');
  const btn = document.getElementById('modesMoreToggle');
  if (!wrap || !btn) return;
  const open = typeof forceOpen === 'boolean' ? forceOpen : wrap.style.display === 'none';
  wrap.style.display = open ? '' : 'none';
  btn.textContent = open ? 'æ”¶èµ·æ›´å¤šæ¨¡å¼' : 'å±•å¼€æ›´å¤šæ¨¡å¼';
}
function ensureMoreModesVisibleForSelection() {
  const hasExtraModeSelected = Array.from(document.querySelectorAll('#modes .ch.sel')).some(el => {
    const modeId = el.dataset.m;
    return modeId && !CORE_MODE_IDS.includes(modeId) && !TOOL_MODE_IDS.includes(modeId);
  });
  if (hasExtraModeSelected) toggleMoreModes(true);
}
function ensureModeChipExists(modeId) {
  if (!modeId || CORE_MODE_IDS.includes(modeId) || TOOL_MODE_IDS.includes(modeId)) return;
  if (document.querySelector(`#modes .ch[data-m="${modeId}"]`)) return;
  const moreContainer = document.getElementById('modesMore');
  if (!moreContainer) return;
  moreContainer.appendChild(makeModeChip(modeId));
}
function updateModeThumbnail(modeId) {
  if (!modeId) return;
  const meta = getModeMeta(modeId);
  const title = document.getElementById('modeThumbTitle');
  const desc = document.getElementById('modeThumbDesc');
  const img = document.getElementById('modeThumbImg');
  if (!title || !desc || !img) return;
  title.textContent = getModeChipLabel(modeId);
  desc.textContent = meta.tip || 'è¯¥æ¨¡å¼æš‚æ— æè¿°';
  const fallbackSvg = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect width="100%" height="100%" fill="#f8f8f8"/><rect x="18" y="18" width="364" height="264" fill="none" stroke="#bbb"/><text x="200" y="140" text-anchor="middle" font-size="26" fill="#333">${modeId}</text><text x="200" y="172" text-anchor="middle" font-size="14" fill="#666">No static thumbnail</text></svg>`
  );
  img.onerror = () => {
    img.onerror = null;
    img.src = fallbackSvg;
  };
  img.src = `${API_BASE}/thumbs/${modeId.toLowerCase()}.png`;
}

// â”€â”€ Toast notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function showToast(msg, type='info', duration=3000) {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = `toast toast-${type}`;
  t.textContent = msg;
  c.appendChild(t);
  requestAnimationFrame(() => t.classList.add('show'));
  setTimeout(() => {
    t.classList.remove('show');
    setTimeout(() => t.remove(), 300);
  }, duration);
}

function formatApiError(payload) {
  if (!payload) return '';
  if (typeof payload === 'string') return payload;

  if (Array.isArray(payload.detail) && payload.detail.length > 0) {
    const first = payload.detail[0];
    if (first?.msg && Array.isArray(first?.loc)) {
      const fieldPath = first.loc
        .slice(1)
        .map((x, i) => (typeof x === 'number' ? `[${x}]` : (i === 0 ? String(x) : `.${x}`)))
        .join('');
      return `${fieldPath || 'body'}: ${first.msg}`;
    }
    if (first?.msg) return first.msg;
  }

  if (typeof payload.detail === 'string') return payload.detail;
  if (typeof payload.message === 'string') return payload.message;
  if (typeof payload.error === 'string') return payload.error;
  return '';
}

// â”€â”€ Confirm dialog (replaces native confirm) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let _confirmResolve = null;
function showConfirm(msg) {
  return new Promise(resolve => {
    _confirmResolve = resolve;
    document.getElementById('confirmMsg').textContent = msg;
    document.getElementById('confirmModal').classList.add('active');
  });
}
function closeConfirm(result) {
  document.getElementById('confirmModal').classList.remove('active');
  if (_confirmResolve) { _confirmResolve(result); _confirmResolve = null; }
}

// â”€â”€ Basic UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function tc(el) {
  el.classList.toggle('sel');
  if (el.dataset.m) {
    updateModeThumbnail(el.dataset.m);
    ensureMoreModesVisibleForSelection();
  }
  updateModeSections();
}

function sp(el, group) {
  document.querySelectorAll(`#${group} .pi`).forEach(i => i.classList.remove('sel'));
  el.classList.add('sel');
}

function selectStrategy(el) {
  sp(el, 'strategy');
  const v = el.dataset.v;
  document.getElementById('strategyDesc').textContent = strategyDescs[v] || '';
  document.getElementById('timeSlotSection').style.display = v === 'time_slot' ? 'block' : 'none';
}

function updateModels() {
  const provider = document.getElementById('llmProvider').value;
  const sel = document.getElementById('llmModel');
  sel.innerHTML = '';
  (llmModels[provider] || []).forEach(m => {
    const opt = document.createElement('option');
    opt.value = m.v;
    opt.textContent = m.n;
    sel.appendChild(opt);
  });
}

function normalizeArrayField(value) {
  if (Array.isArray(value)) return value;
  if (typeof value === 'string') {
    try {
      const parsed = JSON.parse(value);
      return Array.isArray(parsed) ? parsed : [];
    } catch (_) {
      return [];
    }
  }
  return [];
}

// â”€â”€ Time slot rule editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function addTimeSlotRule(startHour=9, endHour=12, modes=[]) {
  const container = document.getElementById('timeSlotRules');
  if (container.children.length >= 12) { showToast('æœ€å¤šæ·»åŠ  12 ä¸ªæ—¶æ®µ', 'error'); return; }

  const row = document.createElement('div');
  row.className = 'ts-row';

  let modesHtml = ALL_MODES.map(m => {
    const sel = modes.includes(m) ? ' sel' : '';
    const tip = (getModeMeta(m).tip || '').replace(/"/g, '&quot;');
    return `<span class="ch${sel}" data-m="${m}" data-tip="${tip}" onclick="tc(this)">${m}</span>`;
  }).join('');

  row.innerHTML = `
    <input type="number" class="inp" min="0" max="23" value="${startHour}" style="width:60px;padding:6px 8px;font-size:.8rem" placeholder="èµ·">
    <span style="color:var(--gy)">â€”</span>
    <input type="number" class="inp" min="0" max="24" value="${endHour}" style="width:60px;padding:6px 8px;font-size:.8rem" placeholder="æ­¢">
    <span style="color:var(--gy);font-size:.75rem">æ—¶</span>
    <div class="ts-modes">${modesHtml}</div>
    <button onclick="this.parentElement.remove()" style="padding:4px 8px;border:1px solid var(--bd);border-radius:6px;cursor:pointer;background:#fff;color:var(--red);font-size:.8rem">âœ•</button>
  `;
  container.appendChild(row);
}

function getTimeSlotRules() {
  const rules = [];
  document.querySelectorAll('#timeSlotRules .ts-row').forEach(row => {
    const inputs = row.querySelectorAll('input[type=number]');
    const startHour = parseInt(inputs[0].value) || 0;
    const endHour = parseInt(inputs[1].value) || 24;
    const modes = [];
    row.querySelectorAll('.ts-modes .ch.sel').forEach(el => modes.push(el.dataset.m));
    if (modes.length > 0) rules.push({ startHour, endHour, modes });
  });
  return rules;
}

function fillTimeSlotRules(rules) {
  const container = document.getElementById('timeSlotRules');
  container.innerHTML = '';
  normalizeArrayField(rules).forEach(r => {
    addTimeSlotRule(r.startHour || 0, r.endHour || 24, r.modes || []);
  });
}

// â”€â”€ Config load / save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadConfig() {
  const mac = document.getElementById('macIn').value.trim();
  if (!mac) { showToast('è¯·è¾“å…¥ MAC åœ°å€', 'error'); return; }

  try {
    const res = await fetch(`${API_BASE}/api/config/${mac}`);
    if (!res.ok) { showToast('æœªæ‰¾åˆ°è¯¥è®¾å¤‡çš„é…ç½®', 'error'); return; }
    const cfg = await res.json();
    fillForm(cfg);
    document.getElementById('configForm').style.display = 'block';
    document.getElementById('historyList').style.display = 'none';
    showToast('é…ç½®åŠ è½½æˆåŠŸ', 'success');
  } catch (e) {
    showToast('åŠ è½½å¤±è´¥: ' + e.message, 'error');
  }
}

async function loadHistory() {
  const mac = document.getElementById('macIn').value.trim();
  if (!mac) { showToast('è¯·è¾“å…¥ MAC åœ°å€', 'error'); return; }

  try {
    const res = await fetch(`${API_BASE}/api/config/${mac}/history`);
    if (!res.ok) { showToast('æœªæ‰¾åˆ°å†å²é…ç½®', 'error'); return; }
    const data = await res.json();
    const configs = data.configs || [];
    if (configs.length === 0) { showToast('æš‚æ— å†å²é…ç½®', 'info'); return; }

    const strategyNames = {random:'éšæœº',cycle:'å¾ªç¯',time_slot:'æ—¶æ®µç»‘å®š',smart:'æ™ºèƒ½'};
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '<h3 style="font-size:1.1rem;margin-bottom:12px">å†å²é…ç½®</h3>';

    configs.forEach((cfg) => {
      const isActive = cfg.is_active === 1;
      const date = new Date(cfg.created_at).toLocaleString('zh-CN');
      const item = document.createElement('div');
      item.className = 'hist-item' + (isActive ? ' active' : '');
      item.innerHTML = `
        <div class="hist-meta">
          <strong>#${cfg.id}</strong> Â· ${date} ${isActive ? '<span style="color:#22c55e">â— å½“å‰ä½¿ç”¨</span>' : ''}
        </div>
        <div class="hist-content">
          <strong>æ¨¡å¼:</strong> ${cfg.modes.join(', ')}<br>
          <strong>åˆ·æ–°:</strong> ${strategyNames[cfg.refresh_strategy] || cfg.refresh_strategy} / ${cfg.refresh_interval}åˆ†é’Ÿ<br>
          <strong>åŸå¸‚:</strong> ${cfg.city} Â· <strong>AI:</strong> ${cfg.llm_provider}/${cfg.llm_model}
        </div>
        <div class="hist-actions">
          <button onclick="useHistoryConfig(${cfg.id})">ç¼–è¾‘æ­¤é…ç½®</button>
          ${!isActive ? `<button onclick="activateConfig(${cfg.id})">ä½¿ç”¨æ­¤é…ç½®</button>` : ''}
        </div>
      `;
      historyList.appendChild(item);
    });

    historyList.style.display = 'block';
    document.getElementById('configForm').style.display = 'none';
  } catch (e) {
    showToast('åŠ è½½å¤±è´¥: ' + e.message, 'error');
  }
}

async function useHistoryConfig(configId) {
  const mac = document.getElementById('macIn').value.trim();
  try {
    const res = await fetch(`${API_BASE}/api/config/${mac}/history`);
    const data = await res.json();
    const cfg = data.configs.find(c => c.id === configId);
    if (!cfg) { showToast('é…ç½®ä¸å­˜åœ¨', 'error'); return; }
    fillForm(cfg);
    document.getElementById('configForm').style.display = 'block';
    document.getElementById('historyList').style.display = 'none';
    showToast('å·²åŠ è½½å†å²é…ç½®ï¼Œå¯ä»¥ç¼–è¾‘åä¿å­˜', 'info');
  } catch (e) {
    showToast('åŠ è½½å¤±è´¥: ' + e.message, 'error');
  }
}

async function activateConfig(configId) {
  const mac = document.getElementById('macIn').value.trim();
  const ok = await showConfirm('ç¡®å®šè¦æ¿€æ´»æ­¤é…ç½®å—ï¼Ÿè®¾å¤‡å°†åœ¨ä¸‹æ¬¡åˆ·æ–°æ—¶åº”ç”¨ã€‚');
  if (!ok) return;

  try {
    const res = await fetch(`${API_BASE}/api/config/${mac}/activate/${configId}`, { method: 'PUT' });
    if (!res.ok) throw new Error('æ¿€æ´»å¤±è´¥');
    showToast('é…ç½®å·²æ¿€æ´»ï¼Œè®¾å¤‡å°†åœ¨ä¸‹æ¬¡åˆ·æ–°æ—¶åº”ç”¨', 'success');
    loadHistory();
  } catch (e) {
    showToast('æ¿€æ´»å¤±è´¥: ' + e.message, 'error');
  }
}

function fillForm(cfg) {
  document.getElementById('nickname').value = cfg.nickname || '';

  // Screen size
  const screenSize = cfg.screen_size || '400x300';
  document.querySelectorAll('#screenSize .pi').forEach(el => {
    el.classList.remove('sel');
    if (el.dataset.v === screenSize) el.classList.add('sel');
  });

  document.getElementById('city').value = cfg.city || 'æ­å·';
  document.getElementById('interval').value = cfg.refresh_interval || 60;
  (cfg.modes || []).forEach(modeId => ensureModeChipExists(modeId));

  // Modes
  document.querySelectorAll('#modes .ch').forEach(el => {
    el.classList.remove('sel');
    if (cfg.modes && cfg.modes.includes(el.dataset.m)) el.classList.add('sel');
  });

  // Strategy
  const strategy = cfg.refresh_strategy || 'random';
  document.querySelectorAll('#strategy .pi').forEach(el => {
    el.classList.remove('sel');
    if (el.dataset.v === strategy) {
      el.classList.add('sel');
      selectStrategy(el);
    }
  });

  // Language
  document.querySelectorAll('#language .pi').forEach(el => {
    el.classList.remove('sel');
    if (el.dataset.v === cfg.language) el.classList.add('sel');
  });

  // Tone
  document.querySelectorAll('#tone .pi').forEach(el => {
    el.classList.remove('sel');
    if (el.dataset.v === cfg.content_tone) el.classList.add('sel');
  });

  // Character Tones
  document.querySelectorAll('#configForm .tc .ch').forEach(el => {
    el.classList.remove('sel');
    if (cfg.character_tones && cfg.character_tones.includes(el.dataset.t)) el.classList.add('sel');
  });

  const builtinTones = ['é²è¿…','ç‹å°æ³¢','å¼ çˆ±ç²','æ‘ä¸Šæ˜¥æ ‘','ç‹å®¶å«','å‘¨æ˜Ÿé©°','ç”„å¬›','ç™½å±•å ‚','è‹æ ¼æ‹‰åº•','åº„å­','å°¼é‡‡','JARVIS','æ™ºå­','é©¬æ–‡'];
  const customTones = (cfg.character_tones || []).filter(t => !builtinTones.includes(t));
  document.getElementById('custTone').value = customTones.length > 0 ? customTones.join(', ') : '';

  // LLM
  document.getElementById('llmProvider').value = cfg.llm_provider || 'deepseek';
  updateModels();
  document.getElementById('llmModel').value = cfg.llm_model || 'deepseek-chat';

  // Countdown events
  fillCountdownEvents(cfg.countdownEvents ?? cfg.countdown_events ?? []);

  // Time slot rules
  fillTimeSlotRules(cfg.time_slot_rules ?? cfg.timeSlotRules ?? []);

  // Memo text
  document.getElementById('memoText').value = cfg.memo_text || cfg.memoText || '';

  // Show/hide mode-specific sections
  updateModeSections();
  ensureMoreModesVisibleForSelection();
  const firstMode = (cfg.modes || [])[0] || CORE_MODE_IDS[0];
  updateModeThumbnail(firstMode);
}

function getScreenDims() {
  const v = document.querySelector('#screenSize .pi.sel')?.dataset.v || '400x300';
  const [w, h] = v.split('x').map(Number);
  return { w, h };
}

function collectFormData() {
  const mac = document.getElementById('macIn').value.trim();
  const modes = [];
  document.querySelectorAll('#modes .ch.sel').forEach(el => modes.push(el.dataset.m));

  const characterTones = [];
  document.querySelectorAll('#configForm .tc .ch.sel').forEach(el => {
    const tone = (el.dataset.t || '').trim();
    if (tone) characterTones.push(tone);
  });
  const custTone = document.getElementById('custTone').value.trim();
  if (custTone) {
    custTone.split(/[,ï¼Œã€]/).forEach(t => { const trimmed = t.trim(); if (trimmed) characterTones.push(trimmed); });
  }

  return {
    mac,
    nickname: document.getElementById('nickname').value.trim(),
    screenSize: document.querySelector('#screenSize .pi.sel')?.dataset.v || '400x300',
    modes,
    refreshStrategy: document.querySelector('#strategy .pi.sel')?.dataset.v || 'random',
    characterTones,
    language: document.querySelector('#language .pi.sel')?.dataset.v || 'zh',
    contentTone: document.querySelector('#tone .pi.sel')?.dataset.v || 'neutral',
    city: document.getElementById('city').value.trim() || 'æ­å·',
    llmProvider: document.getElementById('llmProvider').value,
    llmModel: document.getElementById('llmModel').value,
    refreshInterval: parseInt(document.getElementById('interval').value) || 60,
    countdownEvents: getCountdownEvents(),
    timeSlotRules: getTimeSlotRules(),
    memoText: document.getElementById('memoText').value.trim()
  };
}

function updateModeSections() {
  const modes = [];
  document.querySelectorAll('#modes .ch.sel').forEach(el => modes.push(el.dataset.m));
  document.getElementById('memoSection').style.display = modes.includes('MEMO') ? '' : 'none';
  document.getElementById('countdownSection').style.display = modes.includes('COUNTDOWN') ? '' : 'none';
}

async function saveConfig() {
  const data = collectFormData();
  if (!data.mac) { showToast('è¯·è¾“å…¥ MAC åœ°å€', 'error'); return; }
  if (data.modes.length === 0) { showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå†…å®¹æ¨¡å¼', 'error'); return; }

  try {
    const res = await fetch(`${API_BASE}/api/config`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    if (!res.ok) {
      let errMsg = 'ä¿å­˜å¤±è´¥';
      try {
        const body = await res.json();
        const detail = formatApiError(body);
        if (detail) errMsg = detail;
      } catch (_) {}
      throw new Error(errMsg);
    }
    // Best-effort auto refresh after successful save.
    let refreshQueued = false;
    try {
      const refreshRes = await fetch(`${API_BASE}/api/device/${encodeURIComponent(data.mac)}/refresh`, { method: 'POST' });
      refreshQueued = refreshRes.ok;
    } catch (_) {}

    if (refreshQueued) {
      showToast('é…ç½®ä¿å­˜æˆåŠŸï¼å·²å‘é€åˆ·æ–°æŒ‡ä»¤ï¼Œè®¾å¤‡å°†å°½å¿«åˆ·æ–°ï¼ˆä¹Ÿå¯æ‰‹åŠ¨ç‚¹å‡» BOOT ç«‹å³åˆ·æ–°ï¼‰', 'success');
    } else {
      showToast('é…ç½®ä¿å­˜æˆåŠŸï¼è®¾å¤‡å°†åœ¨ä¸‹æ¬¡åˆ·æ–°æ—¶åº”ç”¨', 'success');
    }
  } catch (e) {
    showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
  }
}

// â”€â”€ Trigger immediate refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function triggerRefresh() {
  const mac = document.getElementById('macIn').value.trim();
  if (!mac) { showToast('è¯·å…ˆè¾“å…¥ MAC åœ°å€', 'error'); return; }

  try {
    const res = await fetch(`${API_BASE}/api/device/${encodeURIComponent(mac)}/refresh`, { method: 'POST' });
    if (!res.ok) throw new Error('è¯·æ±‚å¤±è´¥');
    showToast('åˆ·æ–°æŒ‡ä»¤å·²å‘é€ï¼Œè®¾å¤‡å°†åœ¨ä¸‹æ¬¡å”¤é†’æ—¶åˆ·æ–°ï¼ˆä¹Ÿå¯æ‰‹åŠ¨ç‚¹å‡» BOOT ç«‹å³åˆ·æ–°ï¼‰', 'success');
  } catch (e) {
    showToast('å‘é€å¤±è´¥: ' + e.message, 'error');
  }
}

// â”€â”€ Config import / export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function exportConfig() {
  const data = collectFormData();
  if (!data.mac) { showToast('è¯·å…ˆåŠ è½½é…ç½®', 'error'); return; }
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `inksight-config-${data.mac.replace(/:/g, '')}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('é…ç½®å·²å¯¼å‡º', 'success');
}

function importConfig(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (data.mac) document.getElementById('macIn').value = data.mac;
      // Convert to the format fillForm expects
      const cfg = {
        nickname: data.nickname || '',
        modes: data.modes || [],
        refresh_strategy: data.refreshStrategy || data.refresh_strategy || 'random',
        language: data.language || 'zh',
        content_tone: data.contentTone || data.content_tone || 'neutral',
        character_tones: data.characterTones || data.character_tones || [],
        city: data.city || 'æ­å·',
        llm_provider: data.llmProvider || data.llm_provider || 'deepseek',
        llm_model: data.llmModel || data.llm_model || 'deepseek-chat',
        refresh_interval: data.refreshInterval || data.refresh_interval || 60,
        countdownEvents: data.countdownEvents || [],
        time_slot_rules: data.timeSlotRules || data.time_slot_rules || [],
      };
      fillForm(cfg);
      document.getElementById('configForm').style.display = 'block';
      showToast('é…ç½®å·²å¯¼å…¥ï¼Œæ£€æŸ¥åç‚¹å‡»ä¿å­˜', 'success');
    } catch (err) {
      showToast('JSON æ ¼å¼æ— æ•ˆ: ' + err.message, 'error');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// â”€â”€ Config preview modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openPreviewModal() {
  const data = collectFormData();
  if (data.modes.length === 0) { showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ¨¡å¼', 'error'); return; }

  const selectDiv = document.getElementById('previewModeSelect');
  selectDiv.innerHTML = '<div class="cg">' + data.modes.map(m =>
    `<span class="ch" onclick="previewMode('${m}', this)" style="cursor:pointer">${m}</span>`
  ).join('') + '</div>';

  document.getElementById('previewImg').src = '';
  document.getElementById('previewStatus').textContent = 'é€‰æ‹©ä¸€ä¸ªæ¨¡å¼å¼€å§‹é¢„è§ˆ';
  document.getElementById('previewModal').classList.add('active');
}

function closePreviewModal() {
  document.getElementById('previewModal').classList.remove('active');
}

async function previewMode(mode, el) {
  // Open the preview modal if not already visible
  const modal = document.getElementById('previewModal');
  if (!modal.classList.contains('active')) {
    document.getElementById('previewModeSelect').innerHTML = '';
    document.getElementById('previewImg').src = '';
    modal.classList.add('active');
  }

  if (el) {
    el.closest('.cg').querySelectorAll('.ch').forEach(c => c.classList.remove('sel'));
    el.classList.add('sel');
  }
  document.getElementById('previewStatus').textContent = 'æ¸²æŸ“ä¸­...';
  const img = document.getElementById('previewImg');
  try {
    const start = performance.now();
    const res = await fetch(`${API_BASE}/api/preview?persona=${mode}&v=3.30&w=${getScreenDims().w}&h=${getScreenDims().h}`);
    const elapsed = Math.round(performance.now() - start);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const blob = await res.blob();
    img.src = URL.createObjectURL(blob);
    document.getElementById('previewStatus').textContent = `${mode} Â· ${elapsed}ms Â· ${(blob.size/1024).toFixed(1)}KB`;
  } catch (e) {
    document.getElementById('previewStatus').textContent = 'æ¸²æŸ“å¤±è´¥: ' + e.message;
  }
}

// â”€â”€ Countdown events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function addCountdownEvent(name='', date='', type='countdown') {
  const container = document.getElementById('countdownEvents');
  if (container.children.length >= 10) { showToast('æœ€å¤šæ·»åŠ  10 ä¸ªäº‹ä»¶', 'error'); return; }
  const row = document.createElement('div');
  row.style.cssText = 'display:flex;gap:6px;align-items:center;margin-bottom:6px';
  row.innerHTML = `
    <input type="text" class="inp cd-name" placeholder="äº‹ä»¶åç§°" value="${name}" style="flex:2">
    <input type="date" class="inp cd-date" value="${date}" style="flex:2">
    <select class="sel cd-type" style="flex:1;padding:8px"><option value="countdown" ${type==='countdown'?'selected':''}>å€’è®¡æ—¶</option><option value="countup" ${type==='countup'?'selected':''}>æ­£è®¡æ—¥</option></select>
    <button onclick="this.parentElement.remove()" style="padding:6px 10px;border:1px solid var(--bd);border-radius:6px;cursor:pointer;background:#fff;color:var(--red);font-size:.8rem">âœ•</button>
  `;
  container.appendChild(row);
}

function getCountdownEvents() {
  const events = [];
  document.querySelectorAll('#countdownEvents > div').forEach(row => {
    const name = row.querySelector('.cd-name').value.trim();
    const date = row.querySelector('.cd-date').value;
    const type = row.querySelector('.cd-type').value;
    if (name && date) events.push({ name, date, type });
  });
  return events;
}

function fillCountdownEvents(events) {
  const container = document.getElementById('countdownEvents');
  container.innerHTML = '';
  normalizeArrayField(events).forEach(evt => {
    addCountdownEvent(evt.name || '', evt.date || '', evt.type || 'countdown');
  });
}

// â”€â”€ Custom mode management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const MODE_TEMPLATES = {
  quote: {
    mode_id: "MY_QUOTE",
    display_name: "æˆ‘çš„è¯­å½•",
    icon: "book",
    cacheable: true,
    description: "è‡ªå®šä¹‰è¯­å½•æ¨¡å¼",
    content: {
      type: "llm",
      prompt_template: "ä½ æ˜¯ä¸€ä½äººç”Ÿå¯¼å¸ˆã€‚æ ¹æ®ä»¥ä¸‹ç¯å¢ƒä¿¡æ¯ï¼Œç”Ÿæˆä¸€å¥å¯Œæœ‰å“²ç†çš„è¯­å½•å’Œä½œè€…ï¼Œç”¨ | åˆ†éš”ã€‚\nç¯å¢ƒï¼š{context}",
      output_format: "text_split",
      output_separator: "|",
      output_fields: ["quote", "author"],
      temperature: 0.8,
      fallback: { quote: "ç”Ÿæ´»ä¸æ­¢çœ¼å‰çš„è‹Ÿä¸”", author: "é«˜æ™“æ¾" }
    },
    layout: {
      status_bar: { line_width: 1, dashed: false },
      body: [{ type: "centered_text", field: "quote", font: "noto_serif_light", font_size: 16, vertical_center: true }],
      footer: { label: "MY_QUOTE", attribution_template: "â€” {author}" }
    }
  },
  list: {
    mode_id: "MY_LIST",
    display_name: "æˆ‘çš„åˆ—è¡¨",
    icon: "star",
    cacheable: false,
    description: "è‡ªå®šä¹‰åˆ—è¡¨æ¨¡å¼",
    content: {
      type: "llm_json",
      prompt_template: "æ¨è 5 ä¸ªä»Šæ—¥å€¼å¾—å…³æ³¨çš„è¯é¢˜ï¼Œç”¨ JSON è¾“å‡ºï¼š{{\"title\": \"æ ‡é¢˜\", \"items\": [{{\"name\": \"è¯é¢˜\", \"desc\": \"ç®€è¿°\"}}]}}\nåªè¾“å‡º JSONã€‚\nç¯å¢ƒï¼š{context}",
      output_schema: {
        title: { type: "string", "default": "ä»Šæ—¥è¯é¢˜" },
        items: { type: "array", "default": [{ name: "ç¤ºä¾‹è¯é¢˜", desc: "ç®€è¦æè¿°" }] }
      },
      temperature: 0.8,
      fallback: { title: "ä»Šæ—¥è¯é¢˜", items: [{ name: "æš‚æ— æ•°æ®", desc: "è¯·ç¨åé‡è¯•" }] }
    },
    layout: {
      status_bar: { line_width: 1 },
      body: [
        { type: "spacer", height: 14 },
        { type: "text", field: "title", font: "noto_serif_bold", font_size: 16, align: "center" },
        { type: "spacer", height: 4 },
        { type: "separator", style: "solid", margin_x: 24 },
        { type: "list", field: "items", max_items: 6, item_template: "{name}", right_field: "desc", font_size: 13, margin_x: 24, numbered: true, item_spacing: 18 }
      ],
      footer: { label: "MY_LIST", attribution_template: "InkSight" }
    }
  },
  zen: {
    mode_id: "MY_ZEN",
    display_name: "æç®€å­—",
    icon: "zen",
    cacheable: true,
    description: "ä¸€ä¸ªå¤§å­—ä»£è¡¨å½“ä¸‹",
    content: {
      type: "llm",
      prompt_template: "æ ¹æ®å½“å‰ç¯å¢ƒï¼Œè¾“å‡ºä¸€ä¸ªæœ€æœ‰æ„å¢ƒçš„æ±‰å­—ï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚\nç¯å¢ƒï¼š{context}",
      output_format: "raw",
      output_fields: ["word"],
      post_process: { word: "first_char" },
      temperature: 0.9,
      fallback: { word: "æ‚Ÿ" }
    },
    layout: {
      status_bar: { dashed: true },
      body: [{ type: "centered_text", field: "word", font: "noto_serif_regular", font_size: 48, vertical_center: true }],
      footer: { label: "MY_ZEN", attribution_template: "â€” ...", dashed: true }
    }
  },
  sections: {
    mode_id: "MY_SECTIONS",
    display_name: "åˆ†æ å±•ç¤º",
    icon: "sunny",
    cacheable: false,
    description: "å¤šåŒºå—å†…å®¹å±•ç¤º",
    content: {
      type: "llm_json",
      prompt_template: "ä½ æ˜¯ä¸€ä½ç”Ÿæ´»åŠ©æ‰‹ã€‚ç”¨ JSON è¾“å‡ºä»Šæ—¥æ¨èï¼š{{\"greeting\": \"ä¸€å¥é—®å€™\", \"tip\": \"ä¸€æ¡å®ç”¨å»ºè®®\", \"fun_fact\": \"ä¸€ä¸ªå†·çŸ¥è¯†\"}}\nåªè¾“å‡º JSONã€‚\nç¯å¢ƒï¼š{context}",
      output_schema: {
        greeting: { type: "string", "default": "ç¾å¥½çš„ä¸€å¤©" },
        tip: { type: "string", "default": "å¤šå–æ°´" },
        fun_fact: { type: "string", "default": "èœœèœ‚å¯ä»¥è¯†åˆ«äººè„¸" }
      },
      temperature: 0.8,
      fallback: { greeting: "ç¾å¥½çš„ä¸€å¤©", tip: "ä¿æŒå¾®ç¬‘", fun_fact: "ç« é±¼æœ‰ä¸‰é¢—å¿ƒè„" }
    },
    layout: {
      status_bar: { line_width: 1 },
      body: [
        { type: "spacer", height: 14 },
        { type: "text", field: "greeting", font: "noto_serif_bold", font_size: 16, align: "center" },
        { type: "spacer", height: 8 },
        { type: "separator", style: "solid", margin_x: 24 },
        { type: "section", title: "ä»Šæ—¥å»ºè®®", icon: "tips", children: [
          { type: "text", field: "tip", font: "noto_serif_regular", font_size: 14, align: "left", margin_x: 40 }
        ]},
        { type: "spacer", height: 4 },
        { type: "separator", style: "dashed", margin_x: 24 },
        { type: "section", title: "å†·çŸ¥è¯†", icon: "book", children: [
          { type: "text", field: "fun_fact", font: "noto_serif_light", font_size: 13, align: "left", margin_x: 40 }
        ]}
      ],
      footer: { label: "MY_SECTIONS", attribution_template: "InkSight" }
    }
  }
};

let _editingModeId = null;

async function refreshModeList() {
  const container = document.getElementById('modeList');
  try {
    const res = await fetch(`${API_BASE}/api/modes`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const modes = data.modes || [];

    if (modes.length === 0) {
      container.innerHTML = '<div style="color:var(--gy);font-size:.85rem;text-align:center;padding:16px">æš‚æ— æ¨¡å¼</div>';
      return;
    }

    const srcLabels = { builtin: 'å†…ç½®', builtin_json: 'JSONå†…ç½®', custom: 'è‡ªå®šä¹‰' };
    const srcClasses = { builtin: 'mode-src-builtin', builtin_json: 'mode-src-builtin_json', custom: 'mode-src-custom' };

    container.innerHTML = modes.map(m => {
      const srcLabel = srcLabels[m.source] || m.source;
      const srcClass = srcClasses[m.source] || 'mode-src-builtin';
      const isCustom = m.source === 'custom';
      return `<div class="mode-item">
        <div class="mode-meta">
          <strong>${m.mode_id}</strong>
          <span class="mode-src ${srcClass}">${srcLabel}</span>
          <span style="color:var(--gy);font-size:.8rem;margin-left:6px">${m.display_name}</span>
          ${m.description ? `<p>${m.description}</p>` : ''}
        </div>
        <div class="mode-actions">
          ${isCustom ? `<button onclick="editCustomMode('${m.mode_id}')">ç¼–è¾‘</button>` : ''}
          ${isCustom ? `<button class="btn-del" onclick="deleteCustomMode('${m.mode_id}')">åˆ é™¤</button>` : ''}
          <button onclick="previewMode('${m.mode_id}')">é¢„è§ˆ</button>
        </div>
      </div>`;
    }).join('');

    // Also update the mode chips in the config form with any custom modes
    updateModeChips(modes);
  } catch (e) {
    container.innerHTML = `<div style="color:var(--red);font-size:.85rem;text-align:center;padding:16px">åŠ è½½å¤±è´¥: ${e.message}</div>`;
  }
}

function updateModeChips(modes) {
  const container = document.getElementById('modesMore');
  if (!container) return;
  const existing = new Set();
  document.querySelectorAll('#modes .ch').forEach(el => existing.add(el.dataset.m));

  modes.forEach(m => {
    const modeId = (m.mode_id || '').toUpperCase();
    if (!modeId) return;
    if (CORE_MODE_IDS.includes(modeId) || TOOL_MODE_IDS.includes(modeId)) return;
    if (existing.has(modeId)) return;
    const label = `${modeId} ${m.display_name || getModeMeta(modeId).name || modeId}`;
    const chip = makeModeChip(modeId, label, m.description || '');
    container.appendChild(chip);
    existing.add(modeId);
  });
  ensureMoreModesVisibleForSelection();
}

function openModeEditor(modeId) {
  _editingModeId = modeId || null;
  document.getElementById('modeEditorTitle').textContent = modeId ? `ç¼–è¾‘æ¨¡å¼: ${modeId}` : 'æ–°å»ºè‡ªå®šä¹‰æ¨¡å¼';
  document.getElementById('modeJsonError').textContent = '';

  // Reset AI panel
  document.getElementById('aiDescInput').value = '';
  clearAiImage();
  document.getElementById('aiGenResult').classList.remove('show');
  const btn = document.getElementById('aiGenBtn');
  btn.disabled = false;
  btn.classList.remove('loading');

  if (modeId) {
    switchEditorTab('manual');
  } else {
    switchEditorTab('ai');
    document.getElementById('modeJsonIn').value = JSON.stringify(MODE_TEMPLATES.quote, null, 2);
  }

  document.getElementById('modeEditorModal').classList.add('active');
}

function closeModeEditor() {
  document.getElementById('modeEditorModal').classList.remove('active');
  _editingModeId = null;
}

async function editCustomMode(modeId) {
  try {
    const res = await fetch(`${API_BASE}/api/modes/custom/${modeId}`);
    if (!res.ok) throw new Error('è·å–å¤±è´¥');
    const def = await res.json();
    _editingModeId = modeId;
    document.getElementById('modeEditorTitle').textContent = `ç¼–è¾‘æ¨¡å¼: ${modeId}`;
    document.getElementById('modeJsonIn').value = JSON.stringify(def, null, 2);
    document.getElementById('modeJsonError').textContent = '';
    switchEditorTab('manual');
    document.getElementById('modeEditorModal').classList.add('active');
  } catch (e) {
    showToast('åŠ è½½å¤±è´¥: ' + e.message, 'error');
  }
}

// â”€â”€ AI Mode Generator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let _aiImageBase64 = null;

function switchEditorTab(tab) {
  document.getElementById('tabAi').classList.toggle('active', tab === 'ai');
  document.getElementById('tabManual').classList.toggle('active', tab === 'manual');
  document.getElementById('aiGenPanel').classList.toggle('active', tab === 'ai');
  document.getElementById('manualPanel').classList.toggle('active', tab === 'manual');
}

function handleAiImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  if (file.size > 4 * 1024 * 1024) {
    showToast('å›¾ç‰‡å¤ªå¤§ï¼Œè¯·é€‰æ‹© 4MB ä»¥å†…çš„å›¾ç‰‡', 'error');
    return;
  }
  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      const maxDim = 800;
      let w = img.width, h = img.height;
      if (w > maxDim || h > maxDim) {
        const ratio = Math.min(maxDim / w, maxDim / h);
        w = Math.round(w * ratio);
        h = Math.round(h * ratio);
      }
      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
      _aiImageBase64 = dataUrl.split(',')[1];
      document.getElementById('aiImgPreview').src = dataUrl;
      document.getElementById('aiImgPreview').style.display = 'block';
      document.getElementById('aiImgPlaceholder').style.display = 'none';
      document.getElementById('aiImgUpload').classList.add('has-image');
      document.getElementById('aiImgClear').style.display = 'inline';
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function clearAiImage() {
  _aiImageBase64 = null;
  document.getElementById('aiImgFile').value = '';
  document.getElementById('aiImgPreview').style.display = 'none';
  document.getElementById('aiImgPreview').src = '';
  document.getElementById('aiImgPlaceholder').style.display = 'block';
  document.getElementById('aiImgUpload').classList.remove('has-image');
  document.getElementById('aiImgClear').style.display = 'none';
}

async function generateModeWithAI() {
  const description = document.getElementById('aiDescInput').value.trim();
  if (!description) { showToast('è¯·æè¿°ä½ æƒ³è¦çš„æ¨¡å¼', 'error'); return; }

  const btn = document.getElementById('aiGenBtn');
  btn.disabled = true;
  btn.classList.add('loading');
  document.getElementById('aiGenResult').classList.remove('show');

  const provider = document.getElementById('llmProv')?.value || 'deepseek';
  const model = document.getElementById('llmModel')?.value || 'deepseek-chat';

  try {
    const payload = { description, provider, model };
    if (_aiImageBase64) payload.image_base64 = _aiImageBase64;

    const res = await fetch(`${API_BASE}/api/modes/generate`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
    if (!data.ok) throw new Error(data.error || 'ç”Ÿæˆå¤±è´¥');

    document.getElementById('modeJsonIn').value = JSON.stringify(data.mode_def, null, 2);
    document.getElementById('modeJsonError').textContent = '';
    document.getElementById('aiGenResult').classList.add('show');

    if (data.warning) {
      showToast(data.warning, 'info');
    } else {
      showToast('æ¨¡å¼ç”ŸæˆæˆåŠŸï¼', 'success');
    }
  } catch (e) {
    showToast('AI ç”Ÿæˆå¤±è´¥: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.classList.remove('loading');
  }
}

function fillModeTemplate(key) {
  const tpl = MODE_TEMPLATES[key];
  if (tpl) {
    document.getElementById('modeJsonIn').value = JSON.stringify(tpl, null, 2);
    document.getElementById('modeJsonError').textContent = '';
  }
}

function validateModeJson() {
  const textarea = document.getElementById('modeJsonIn');
  const errorDiv = document.getElementById('modeJsonError');
  try {
    const obj = JSON.parse(textarea.value);
    if (!obj.mode_id) { errorDiv.textContent = 'mode_id å¿…å¡«'; return false; }
    if (!obj.content || !obj.content.type) { errorDiv.textContent = 'content.type å¿…å¡«'; return false; }
    if (!obj.layout || !obj.layout.body || !obj.layout.body.length) { errorDiv.textContent = 'layout.body å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªå—'; return false; }
    errorDiv.textContent = '';
    return true;
  } catch (e) {
    errorDiv.textContent = 'JSON æ ¼å¼é”™è¯¯: ' + e.message;
    return false;
  }
}

async function saveModeDefinition() {
  if (!validateModeJson()) { showToast('è¯·ä¿®æ­£ JSON é”™è¯¯', 'error'); return; }

  try {
    const def = JSON.parse(document.getElementById('modeJsonIn').value);
    const res = await fetch(`${API_BASE}/api/modes/custom`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(def)
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'ä¿å­˜å¤±è´¥');
    showToast(`æ¨¡å¼ ${data.mode_id} ä¿å­˜æˆåŠŸ`, 'success');
    closeModeEditor();
    refreshModeList();
  } catch (e) {
    showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
  }
}

async function deleteCustomMode(modeId) {
  const ok = await showConfirm(`ç¡®å®šåˆ é™¤è‡ªå®šä¹‰æ¨¡å¼ "${modeId}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`);
  if (!ok) return;

  try {
    const res = await fetch(`${API_BASE}/api/modes/custom/${modeId}`, { method: 'DELETE' });
    if (!res.ok) throw new Error('åˆ é™¤å¤±è´¥');
    showToast(`æ¨¡å¼ ${modeId} å·²åˆ é™¤`, 'success');
    refreshModeList();
  } catch (e) {
    showToast('åˆ é™¤å¤±è´¥: ' + e.message, 'error');
  }
}

async function previewCustomMode() {
  if (!validateModeJson()) { showToast('è¯·ä¿®æ­£ JSON é”™è¯¯', 'error'); return; }

  try {
    const def = JSON.parse(document.getElementById('modeJsonIn').value);
    // Save temporarily, then preview
    const saveRes = await fetch(`${API_BASE}/api/modes/custom`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(def)
    });
    if (!saveRes.ok) {
      const err = await saveRes.json();
      throw new Error(err.error || 'ä¿å­˜å¤±è´¥');
    }

    const modeId = def.mode_id.toUpperCase();
    const img = document.getElementById('previewImg');
    document.getElementById('previewStatus').textContent = 'æ¸²æŸ“ä¸­...';
    document.getElementById('previewModal').classList.add('active');

    const start = performance.now();
    const res = await fetch(`${API_BASE}/api/preview?persona=${modeId}&v=3.30&w=${getScreenDims().w}&h=${getScreenDims().h}`);
    const elapsed = Math.round(performance.now() - start);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const blob = await res.blob();
    img.src = URL.createObjectURL(blob);
    document.getElementById('previewStatus').textContent = `${modeId} Â· ${elapsed}ms Â· ${(blob.size/1024).toFixed(1)}KB`;
    document.getElementById('previewModeSelect').innerHTML = '';
  } catch (e) {
    showToast('é¢„è§ˆå¤±è´¥: ' + e.message, 'error');
  }
}

// â”€â”€ Device auto-discovery â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadDeviceList() {
  try {
    const res = await fetch(`${API_BASE}/api/stats/overview`);
    if (!res.ok) return;
    const data = await res.json();
    const devices = data.devices || [];
    if (devices.length === 0) return;

    const container = document.getElementById('deviceList');
    container.innerHTML = '<div style="font-size:.72rem;color:var(--gy);margin-bottom:4px">å·²å‘ç°è®¾å¤‡ï¼š</div>' +
      '<div class="cg" style="gap:4px">' +
      devices.map(d => {
        const shortMac = d.mac.replace(/:/g, '').slice(-6);
        const ago = timeSince(d.last_seen);
        return `<span class="ch" style="font-size:.72rem;padding:4px 10px" onclick="selectDevice('${d.mac}')" title="æœ€è¿‘æ´»è·ƒ: ${ago}å‰">${shortMac} <span style="opacity:.6">(${d.total_renders})</span></span>`;
      }).join('') +
      '</div>';
  } catch (e) {}
}

function selectDevice(mac) {
  document.getElementById('macIn').value = mac;
  loadConfig();
}

function timeSince(isoStr) {
  const ms = Date.now() - new Date(isoStr).getTime();
  const s = Math.floor(ms / 1000);
  if (s < 60) return s + 'ç§’';
  const m = Math.floor(s / 60);
  if (m < 60) return m + 'åˆ†é’Ÿ';
  const h = Math.floor(m / 60);
  if (h < 24) return h + 'å°æ—¶';
  return Math.floor(h / 24) + 'å¤©';
}

// â”€â”€ Inline preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function showInlinePreview(mode) {
  const panel = document.getElementById('inlinePreview');
  panel.style.display = 'block';
  const status = document.getElementById('inlinePreviewStatus');
  const img = document.getElementById('inlinePreviewImg');
  status.textContent = `æ¸²æŸ“ ${mode} ä¸­...`;

  try {
    const start = performance.now();
    const mac = document.getElementById('macIn').value.trim();
    let url = `${API_BASE}/api/preview?persona=${mode}&v=3.30&w=${getScreenDims().w}&h=${getScreenDims().h}`;
    if (mac) url += `&mac=${encodeURIComponent(mac)}`;
    const res = await fetch(url);
    const elapsed = Math.round(performance.now() - start);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const blob = await res.blob();
    img.src = URL.createObjectURL(blob);
    status.textContent = `${mode} Â· ${elapsed}ms Â· ${(blob.size/1024).toFixed(1)}KB`;
  } catch (e) {
    status.textContent = 'æ¸²æŸ“å¤±è´¥: ' + e.message;
  }
}

// â”€â”€ Initialize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
updateModels();
refreshModeList();
loadDeviceList();
updateModeThumbnail(CORE_MODE_IDS[0]);

const urlParams = new URLSearchParams(window.location.search);
const macParam = urlParams.get('mac');
if (macParam) {
  document.getElementById('macIn').value = macParam;
  loadConfig();
}

// Setup Wizard
function checkShowWizard(){
  // Show wizard if no config exists for current MAC
  var mac = new URLSearchParams(window.location.search).get('mac');
  if(!mac) return;
  fetch('/api/config/'+encodeURIComponent(mac)).then(r=>{
    if (r.status === 404) return null;
    if (!r.ok) throw new Error('load failed');
    return r.json();
  }).then(d=>{
    if(!d || !d.modes || d.modes.length === 0){
      document.getElementById('setupWizard').style.display='flex';
    }
  }).catch(()=>{
    document.getElementById('setupWizard').style.display='flex';
  });
}

function wizNext(step){
  for(var i=1;i<=3;i++){
    document.getElementById('wizStep'+i).style.display=(i===step?'block':'none');
    var ws=document.getElementById('ws'+i);
    ws.className='wiz-step'+(i===step?' active':(i<step?' done':''));
  }
}
function wizBack(step){wizNext(step);}

function selectWizPreset(el){
  document.querySelectorAll('.wiz-preset').forEach(p=>p.classList.remove('selected'));
  el.classList.add('selected');
}

function wizFinish(){
  var preset=document.querySelector('.wiz-preset.selected');
  var presetName=preset?preset.dataset.preset:'recommended';
  var presetModes={
    recommended:['DAILY','WEATHER','ZEN','STOIC','BRIEFING'],
    literary:['ZEN','POETRY','ARTWALL','ALMANAC'],
    efficiency:['BRIEFING','WEATHER','COUNTDOWN','DAILY'],
    minimal:['STOIC','ZEN']
  };
  var modes=presetModes[presetName]||presetModes.recommended;
  var provider=document.getElementById('wizLlmProvider').value;
  var apiKey=document.getElementById('wizApiKey').value;
  var refresh=parseInt(document.getElementById('wizRefresh').value)||60;
  var city=document.getElementById('wizCity').value||'æ­å·';
  
  var cfg={
    modes:modes,
    llmProvider:provider,
    apiKey:apiKey,
    refreshInterval:refresh,
    refreshStrategy:'random',
    language:'zh',
    contentTone:'neutral',
    city:city
  };
  
  var mac=new URLSearchParams(window.location.search).get('mac');
  fetch('/api/config?mac='+encodeURIComponent(mac),{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(cfg)
  }).then(r=>r.json()).then(()=>{
    document.getElementById('setupWizard').style.display='none';
    location.reload();
  }).catch(()=>{
    document.getElementById('setupWizard').style.display='none';
    alert('é…ç½®ä¿å­˜å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é…ç½®');
  });
}

// Check on page load
document.addEventListener('DOMContentLoaded', checkShowWizard);
</script>
</body>
</html>

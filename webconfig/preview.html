<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InkSight — Preview Console</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #fafafa;
      --card-bg: #ffffff;
      --border: #e5e5e5;
      --text: #1a1a1a;
      --text-secondary: #737373;
      --accent: #171717;
      --accent-hover: #404040;
      --green: #16a34a;
      --green-bg: #f0fdf4;
      --green-border: #bbf7d0;
      --red: #dc2626;
      --radius: 10px;
      --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 28px;
    }
    .header h1 {
      font-size: 1.35rem;
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    .header h1 span { color: var(--text-secondary); font-weight: 400; }
    .health-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--green);
      background: var(--green-bg);
      border: 1px solid var(--green-border);
      padding: 5px 12px;
      border-radius: 16px;
    }
    .health-dot {
      width: 6px; height: 6px;
      background: var(--green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Layout */
    .main-layout {
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: 24px;
      align-items: start;
    }
    @media (max-width: 720px) {
      .main-layout { grid-template-columns: 1fr; }
    }

    /* Card */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card-header {
      padding: 12px 16px;
      font-size: 0.72rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
      background: #fafafa;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-body { padding: 16px; }

    /* Preview Area */
    .preview-area { text-align: center; }
    .screen-frame {
      display: inline-block;
      background: #fff;
      border: 2px solid #d4d4d4;
      border-radius: 6px;
      padding: 8px;
      box-shadow: inset 0 0 0 1px #e5e5e5, 0 4px 12px rgba(0,0,0,0.08);
      position: relative;
      transition: all 0.3s ease;
    }
    .screen-frame img {
      display: block;
      background: #fff;
      image-rendering: auto;
    }
    .screen-label {
      margin-top: 10px;
      font-size: 0.7rem;
      color: var(--text-secondary);
      letter-spacing: 0.03em;
    }

    /* Loading overlay */
    .loading-overlay {
      position: absolute;
      inset: 8px;
      background: rgba(255,255,255,0.85);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .loading-overlay.active { opacity: 1; pointer-events: auto; }
    .spinner {
      width: 28px; height: 28px;
      border: 2.5px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { font-size: 0.75rem; color: var(--text-secondary); }

    /* Controls */
    .form-group { margin-bottom: 14px; }
    .form-group:last-child { margin-bottom: 0; }
    .form-label {
      display: block;
      font-size: 0.72rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 6px;
    }

    /* Persona buttons */
    .persona-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 5px;
    }
    .persona-section { margin-bottom: 10px; }
    .persona-section:last-of-type { margin-bottom: 0; }
    .persona-section-title {
      font-size: 0.64rem;
      color: var(--text-secondary);
      letter-spacing: 0.03em;
      margin-bottom: 5px;
    }
    .persona-fold-toggle {
      margin-top: 6px;
      padding: 6px 10px;
      font-size: 0.7rem;
      border: 1px solid var(--border);
      border-radius: 7px;
      background: #fff;
      color: var(--text-secondary);
      cursor: pointer;
      width: 100%;
    }
    .persona-fold-toggle:hover { border-color: #a3a3a3; color: var(--text); }
    .persona-btn {
      padding: 8px 4px;
      font-size: 0.78rem;
      font-weight: 600;
      font-family: inherit;
      border: 1.5px solid var(--border);
      border-radius: 7px;
      background: #fff;
      cursor: pointer;
      transition: all 0.15s;
      color: var(--text);
      text-align: center;
    }
    .persona-btn:hover { border-color: #a3a3a3; background: #fafafa; }
    .persona-btn.active {
      border-color: var(--accent);
      background: var(--accent);
      color: #fff;
    }
    .persona-btn .label { display: block; font-size: 0.65rem; font-weight: 400; opacity: 0.7; margin-top: 1px; }
    .persona-btn.active .label { opacity: 0.85; }

    /* Voltage slider */
    .range-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    input[type="range"] {
      -webkit-appearance: none;
      flex: 1;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px; height: 16px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
    }
    .range-value {
      font-size: 0.82rem;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
      min-width: 42px;
      text-align: right;
    }
    .range-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.62rem;
      color: #a3a3a3;
      margin-top: 3px;
    }

    /* Generate button */
    .btn-generate {
      display: block;
      width: 100%;
      padding: 10px;
      font-size: 0.85rem;
      font-weight: 600;
      font-family: inherit;
      color: #fff;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s;
      margin-top: 16px;
    }
    .btn-generate:hover { background: var(--accent-hover); }
    .btn-generate:active { transform: scale(0.98); }
    .btn-generate:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Info panel */
    .info-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 4px 10px;
      font-size: 0.75rem;
    }
    .info-label { color: var(--text-secondary); font-weight: 500; }
    .info-value { font-variant-numeric: tabular-nums; }
    .info-value.error { color: var(--red); }

    /* Auto mode tag */
    .auto-tag {
      display: inline-block;
      font-size: 0.6rem;
      font-weight: 600;
      background: #f5f5f5;
      color: #737373;
      padding: 1px 5px;
      border-radius: 3px;
      margin-left: 4px;
      vertical-align: middle;
    }

    /* E-ink flash animation */
    @keyframes eink-flash {
      0% { filter: invert(0); }
      15% { filter: invert(1); }
      30% { filter: invert(0); }
      45% { filter: invert(0.6); }
      60% { filter: invert(0); }
      100% { filter: invert(0); }
    }
    .screen-frame.flash img {
      animation: eink-flash 0.5s ease;
    }

    /* History panel */
    .history-list {
      max-height: 300px;
      overflow-y: auto;
    }
    .history-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.1s;
    }
    .history-item:hover { background: #fafafa; }
    .history-item:last-child { border-bottom: none; }
    .history-thumb {
      width: 60px;
      height: 45px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: #f5f5f5;
    }
    .history-info { flex: 1; min-width: 0; }
    .history-info .h-mode { font-size: 0.75rem; font-weight: 600; }
    .history-info .h-meta { font-size: 0.65rem; color: var(--text-secondary); }

    /* Progress bar for All Modes */
    .progress-bar {
      height: 3px;
      background: var(--border);
      border-radius: 2px;
      margin-top: 8px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: var(--accent);
      transition: width 0.3s ease;
      border-radius: 2px;
    }

    /* Resolution selector */
    .res-grid {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .res-btn {
      padding: 4px 8px;
      font-size: 0.68rem;
      font-family: inherit;
      border: 1px solid var(--border);
      border-radius: 5px;
      background: #fff;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.15s;
    }
    .res-btn:hover { border-color: #a3a3a3; }
    .res-btn.active { border-color: var(--accent); background: var(--accent); color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>InkSight <span>Preview Console</span></h1>
      <span class="health-badge" id="healthBadge">
        <span class="health-dot"></span>
        <span id="healthText">Checking...</span>
      </span>
    </div>

    <!-- Main -->
    <div class="main-layout">
      <!-- Left: Preview -->
      <div>
        <div class="card">
          <div class="card-header">Render Output</div>
          <div class="card-body preview-area">
            <div class="screen-frame" id="screenFrame">
              <img id="previewImg" src="" alt="Preview"
                   style="background:#f5f5f5;">
              <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
                <div class="loading-text">Rendering...</div>
              </div>
            </div>
            <div class="screen-label" id="screenLabel">400 × 300 · 1-bit monochrome</div>
          </div>
        </div>

        <!-- Response Info -->
        <div class="card" style="margin-top: 12px;">
          <div class="card-header">Response Info</div>
          <div class="card-body">
            <div class="info-grid" id="infoGrid">
              <span class="info-label">Status</span>
              <span class="info-value" id="infoStatus">—</span>
              <span class="info-label">Persona</span>
              <span class="info-value" id="infoPersona">—</span>
              <span class="info-label">Render Time</span>
              <span class="info-value" id="infoTime">—</span>
              <span class="info-label">Image Size</span>
              <span class="info-value" id="infoSize">—</span>
              <span class="info-label">Request URL</span>
              <span class="info-value" id="infoUrl" style="word-break:break-all;">—</span>
            </div>
          </div>
        </div>

        <!-- Render History -->
        <div class="card" style="margin-top: 12px;">
          <div class="card-header">
            <span>Render History</span>
            <button onclick="clearHistory()" style="border:none;background:none;font-size:.68rem;color:var(--text-secondary);cursor:pointer">Clear</button>
          </div>
          <div class="card-body" style="padding:0">
            <div class="history-list" id="historyList">
              <div style="padding:16px;text-align:center;font-size:.75rem;color:var(--text-secondary)">No renders yet</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Controls -->
      <div>
        <div class="card">
          <div class="card-header">Controls</div>
          <div class="card-body">
            <!-- Persona -->
            <div class="form-group">
              <label class="form-label">Persona Mode</label>
              <div class="persona-section">
                <div class="persona-section-title">自动</div>
                <div class="persona-grid">
                  <button class="persona-btn" data-persona="AUTO" onclick="selectPersona(this)">
                    AUTO<span class="label">自动选择</span>
                  </button>
                </div>
              </div>
              <div class="persona-section">
                <div class="persona-section-title">推荐核心（10）</div>
                <div class="persona-grid">
                  <button class="persona-btn active" data-persona="DAILY" onclick="selectPersona(this)">
                    DAILY<span class="label">每日推荐</span>
                  </button>
                  <button class="persona-btn" data-persona="WEATHER" onclick="selectPersona(this)">
                    WEATHER<span class="label">天气看板</span>
                  </button>
                  <button class="persona-btn" data-persona="ZEN" onclick="selectPersona(this)">
                    ZEN<span class="label">禅意大字</span>
                  </button>
                  <button class="persona-btn" data-persona="BRIEFING" onclick="selectPersona(this)">
                    BRIEFING<span class="label">AI 简报</span>
                  </button>
                  <button class="persona-btn" data-persona="STOIC" onclick="selectPersona(this)">
                    STOIC<span class="label">斯多葛</span>
                  </button>
                  <button class="persona-btn" data-persona="POETRY" onclick="selectPersona(this)">
                    POETRY<span class="label">每日诗词</span>
                  </button>
                  <button class="persona-btn" data-persona="ARTWALL" onclick="selectPersona(this)">
                    ARTWALL<span class="label">AI 画廊</span>
                  </button>
                  <button class="persona-btn" data-persona="ALMANAC" onclick="selectPersona(this)">
                    ALMANAC<span class="label">老黄历</span>
                  </button>
                  <button class="persona-btn" data-persona="RECIPE" onclick="selectPersona(this)">
                    RECIPE<span class="label">每日食谱</span>
                  </button>
                  <button class="persona-btn" data-persona="COUNTDOWN" onclick="selectPersona(this)">
                    COUNTDOWN<span class="label">倒计时</span>
                  </button>
                </div>
              </div>
              <div class="persona-section">
                <div class="persona-section-title">工具模式</div>
                <div class="persona-grid">
                  <button class="persona-btn" data-persona="MEMO" onclick="selectPersona(this)">
                    MEMO<span class="label">便签留言</span>
                  </button>
                  <button class="persona-btn" data-persona="HABIT" onclick="selectPersona(this)">
                    HABIT<span class="label">习惯打卡</span>
                  </button>
                </div>
              </div>
              <button type="button" class="persona-fold-toggle" id="personaMoreToggle" onclick="togglePersonaMore()">展开更多模式</button>
              <div class="persona-section" id="personaMoreWrap" style="display:none">
                <div class="persona-section-title">更多模式</div>
                <div class="persona-grid">
                  <button class="persona-btn" data-persona="ROAST" onclick="selectPersona(this)">
                    ROAST<span class="label">毒舌吐槽</span>
                  </button>
                  <button class="persona-btn" data-persona="FITNESS" onclick="selectPersona(this)">
                    FITNESS<span class="label">健身计划</span>
                  </button>
                  <button class="persona-btn" data-persona="RIDDLE" onclick="selectPersona(this)">
                    RIDDLE<span class="label">脑筋急转弯</span>
                  </button>
                  <button class="persona-btn" data-persona="CHALLENGE" onclick="selectPersona(this)">
                    CHALLENGE<span class="label">每日挑战</span>
                  </button>
                  <button class="persona-btn" data-persona="STORY" onclick="selectPersona(this)">
                    STORY<span class="label">微小说</span>
                  </button>
                  <button class="persona-btn" data-persona="LIFEBAR" onclick="selectPersona(this)">
                    LIFEBAR<span class="label">人生进度</span>
                  </button>
                  <button class="persona-btn" data-persona="THISDAY" onclick="selectPersona(this)">
                    THISDAY<span class="label">历史上的今天</span>
                  </button>
                  <button class="persona-btn" data-persona="LETTER" onclick="selectPersona(this)">
                    LETTER<span class="label">给未来的信</span>
                  </button>
                  <button class="persona-btn" data-persona="QUESTION" onclick="selectPersona(this)">
                    QUESTION<span class="label">每日一问</span>
                  </button>
                  <button class="persona-btn" data-persona="BIAS" onclick="selectPersona(this)">
                    BIAS<span class="label">认知偏差</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Voltage -->
            <div class="form-group">
              <label class="form-label">Battery Voltage</label>
              <div class="range-row">
                <input type="range" id="voltageSlider" min="2.80" max="3.50" step="0.01" value="3.30">
                <span class="range-value" id="voltageValue">3.30V</span>
              </div>
              <div class="range-labels">
                <span>2.80V (Dead)</span>
                <span>3.50V (Full)</span>
              </div>
            </div>

            <!-- Resolution -->
            <div class="form-group">
              <label class="form-label">Screen Size</label>
              <div class="res-grid">
                <button class="res-btn active" data-w="400" data-h="300" onclick="selectResolution(this)">4.2" 400×300</button>
                <button class="res-btn" data-w="296" data-h="128" onclick="selectResolution(this)">2.9" 296×128</button>
                <button class="res-btn" data-w="648" data-h="480" onclick="selectResolution(this)">5.83" 648×480</button>
                <button class="res-btn" data-w="800" data-h="480" onclick="selectResolution(this)">7.5" 800×480</button>
              </div>
            </div>

            <button class="btn-generate" id="generateBtn" onclick="generate()">
              Generate Preview
            </button>
          </div>
        </div>

        <!-- Quick Presets -->
        <div class="card" style="margin-top: 12px;">
          <div class="card-header">Quick Presets</div>
          <div class="card-body">
            <div style="display:flex; flex-wrap:wrap; gap:6px;">
              <button class="persona-btn" style="flex:1;min-width:70px;font-size:0.72rem;padding:6px;"
                      onclick="applyPreset('full')">Full</button>
              <button class="persona-btn" style="flex:1;min-width:70px;font-size:0.72rem;padding:6px;"
                      onclick="applyPreset('low')">Low</button>
              <button class="persona-btn" id="allModesBtn" style="flex:1;min-width:70px;font-size:0.72rem;padding:6px;"
                      onclick="applyPreset('all')">All Modes</button>
            </div>
            <div class="progress-bar" id="allModesProgress" style="display:none">
              <div class="progress-bar-fill" id="allModesFill" style="width:0%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ── State ───────────────────────────────────────────────────
    let selectedPersona = 'DAILY';
    let currentAbortController = null;
    let allModesRunning = false;
    let renderHistory = [];
    let currentResolution = { w: 400, h: 300, label: '4.2"' };
    const CORE_PERSONA_MODES = ['DAILY','WEATHER','ZEN','BRIEFING','STOIC','POETRY','ARTWALL','ALMANAC','RECIPE','COUNTDOWN'];
    const TOOL_PERSONA_MODES = ['MEMO','HABIT'];
    const EXTRA_PERSONA_MODES = ['ROAST','FITNESS','RIDDLE','CHALLENGE','STORY','LIFEBAR','THISDAY','LETTER','QUESTION','BIAS'];
    const ALL_PERSONA_MODES = [...CORE_PERSONA_MODES, ...TOOL_PERSONA_MODES, ...EXTRA_PERSONA_MODES];

    // ── DOM refs ────────────────────────────────────────────────
    const previewImg = document.getElementById('previewImg');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const screenFrame = document.getElementById('screenFrame');
    const voltageSlider = document.getElementById('voltageSlider');
    const voltageValue = document.getElementById('voltageValue');
    const generateBtn = document.getElementById('generateBtn');

    // Set initial image size
    previewImg.style.width = '400px';
    previewImg.style.height = '300px';

    // ── Voltage slider ──────────────────────────────────────────
    voltageSlider.addEventListener('input', () => {
      voltageValue.textContent = parseFloat(voltageSlider.value).toFixed(2) + 'V';
    });

    // ── Resolution selector ─────────────────────────────────────
    function selectResolution(btn) {
      document.querySelectorAll('.res-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const w = parseInt(btn.dataset.w);
      const h = parseInt(btn.dataset.h);
      currentResolution = { w, h, label: btn.textContent.trim() };
      previewImg.style.width = w + 'px';
      previewImg.style.height = h + 'px';
      document.getElementById('screenLabel').textContent = `${w} × ${h} · 1-bit monochrome`;
    }

    // ── Persona selection ───────────────────────────────────────
    function selectPersona(btn) {
      document.querySelectorAll('.persona-grid .persona-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedPersona = btn.dataset.persona;
      ensurePersonaMoreVisibleForSelected(selectedPersona);
    }

    function togglePersonaMore(forceOpen) {
      const wrap = document.getElementById('personaMoreWrap');
      const btn = document.getElementById('personaMoreToggle');
      if (!wrap || !btn) return;
      const open = typeof forceOpen === 'boolean' ? forceOpen : wrap.style.display === 'none';
      wrap.style.display = open ? '' : 'none';
      btn.textContent = open ? '收起更多模式' : '展开更多模式';
    }

    function ensurePersonaMoreVisibleForSelected(mode) {
      if (EXTRA_PERSONA_MODES.includes(mode)) {
        togglePersonaMore(true);
      }
    }

    // ── Generate preview (with AbortController) ─────────────────
    async function generate() {
      // Cancel any in-flight request
      if (currentAbortController) {
        currentAbortController.abort();
      }
      currentAbortController = new AbortController();

      generateBtn.disabled = true;
      loadingOverlay.classList.add('active');

      const v = parseFloat(voltageSlider.value).toFixed(2);
      const persona = selectedPersona === 'AUTO' ? '' : selectedPersona;
      let url = `/api/preview?v=${v}&w=${currentResolution.w}&h=${currentResolution.h}`;
      if (persona) url += `&persona=${persona}`;

      document.getElementById('infoUrl').textContent = url;
      document.getElementById('infoStatus').textContent = '⏳ Loading...';
      document.getElementById('infoStatus').className = 'info-value';
      document.getElementById('infoPersona').textContent = persona || 'AUTO';
      document.getElementById('infoTime').textContent = '...';
      document.getElementById('infoSize').textContent = '...';

      const startTime = performance.now();

      try {
        const resp = await fetch(url, { signal: currentAbortController.signal });
        const elapsed = Math.round(performance.now() - startTime);
        const blob = await resp.blob();

        if (resp.ok) {
          const imgUrl = URL.createObjectURL(blob);
          previewImg.src = imgUrl;
          document.getElementById('infoStatus').textContent = `✓ ${resp.status} OK`;
          // E-ink flash animation
          screenFrame.classList.add('flash');
          setTimeout(() => screenFrame.classList.remove('flash'), 500);

          // Add to history
          addToHistory(persona || 'AUTO', imgUrl, elapsed, blob.size);
        } else {
          document.getElementById('infoStatus').textContent = `✗ ${resp.status} Error`;
          document.getElementById('infoStatus').className = 'info-value error';
        }

        document.getElementById('infoTime').textContent = `${elapsed}ms`;
        document.getElementById('infoSize').textContent = `${(blob.size / 1024).toFixed(1)} KB`;
        document.getElementById('infoPersona').textContent = persona || 'AUTO → (server decides)';

      } catch (err) {
        if (err.name === 'AbortError') {
          document.getElementById('infoStatus').textContent = '⚡ Cancelled';
          document.getElementById('infoStatus').className = 'info-value';
        } else {
          document.getElementById('infoStatus').textContent = `✗ Network Error`;
          document.getElementById('infoStatus').className = 'info-value error';
        }
        document.getElementById('infoTime').textContent = '—';
      }

      loadingOverlay.classList.remove('active');
      generateBtn.disabled = false;
      currentAbortController = null;
    }

    // ── Render history ──────────────────────────────────────────
    function addToHistory(persona, imageUrl, elapsed, size) {
      const entry = {
        persona,
        imageUrl,
        elapsed,
        size,
        timestamp: new Date().toLocaleTimeString('zh-CN')
      };
      renderHistory.unshift(entry);
      if (renderHistory.length > 30) {
        const removed = renderHistory.pop();
        URL.revokeObjectURL(removed.imageUrl);
      }
      renderHistoryUI();
    }

    function renderHistoryUI() {
      const container = document.getElementById('historyList');
      if (renderHistory.length === 0) {
        container.innerHTML = '<div style="padding:16px;text-align:center;font-size:.75rem;color:var(--text-secondary)">No renders yet</div>';
        return;
      }
      container.innerHTML = renderHistory.map((h, i) => `
        <div class="history-item" onclick="viewHistoryItem(${i})">
          <img class="history-thumb" src="${h.imageUrl}" alt="${h.persona}">
          <div class="history-info">
            <div class="h-mode">${h.persona}</div>
            <div class="h-meta">${h.timestamp} · ${h.elapsed}ms · ${(h.size/1024).toFixed(1)}KB</div>
          </div>
        </div>
      `).join('');
    }

    function viewHistoryItem(index) {
      const h = renderHistory[index];
      if (h) {
        previewImg.src = h.imageUrl;
        document.getElementById('infoPersona').textContent = h.persona;
        document.getElementById('infoTime').textContent = h.elapsed + 'ms';
        document.getElementById('infoSize').textContent = (h.size/1024).toFixed(1) + ' KB';
        document.getElementById('infoStatus').textContent = '✓ From History';
        screenFrame.classList.add('flash');
        setTimeout(() => screenFrame.classList.remove('flash'), 500);
      }
    }

    function clearHistory() {
      renderHistory.forEach(h => URL.revokeObjectURL(h.imageUrl));
      renderHistory = [];
      renderHistoryUI();
    }

    // ── Presets (with throttling and cancel for All Modes) ──────
    async function applyPreset(preset) {
      if (preset === 'full') {
        voltageSlider.value = 3.45;
        voltageValue.textContent = '3.45V';
        generate();
      } else if (preset === 'low') {
        voltageSlider.value = 3.10;
        voltageValue.textContent = '3.10V';
        generate();
      } else if (preset === 'all') {
        if (allModesRunning) {
          // Cancel running All Modes
          allModesRunning = false;
          document.getElementById('allModesBtn').textContent = 'All Modes';
          document.getElementById('allModesProgress').style.display = 'none';
          if (currentAbortController) currentAbortController.abort();
          return;
        }

        allModesRunning = true;
        document.getElementById('allModesBtn').textContent = 'Stop';
        const progressBar = document.getElementById('allModesProgress');
        const progressFill = document.getElementById('allModesFill');
        progressBar.style.display = 'block';

        const modes = ALL_PERSONA_MODES;
        for (let i = 0; i < modes.length; i++) {
          if (!allModesRunning) break;

          selectedPersona = modes[i];
          ensurePersonaMoreVisibleForSelected(selectedPersona);
          document.querySelectorAll('.persona-grid .persona-btn').forEach(b => {
            b.classList.toggle('active', b.dataset.persona === modes[i]);
          });

          progressFill.style.width = ((i + 1) / modes.length * 100) + '%';
          await generate();

          if (!allModesRunning) break;
          if (i < modes.length - 1) {
            await new Promise(r => setTimeout(r, 1500));
          }
        }

        allModesRunning = false;
        document.getElementById('allModesBtn').textContent = 'All Modes';
        progressBar.style.display = 'none';
        progressFill.style.width = '0%';
      }
    }

    // ── Health check ────────────────────────────────────────────
    async function checkHealth() {
      try {
        const resp = await fetch('/api/health');
        const data = await resp.json();
        document.getElementById('healthText').textContent = `v${data.version} · OK`;
        document.getElementById('healthBadge').style.color = 'var(--green)';
        document.getElementById('healthBadge').style.borderColor = 'var(--green-border)';
        document.getElementById('healthBadge').style.background = 'var(--green-bg)';
      } catch {
        document.getElementById('healthText').textContent = 'Offline';
        document.getElementById('healthBadge').style.color = 'var(--red)';
        document.getElementById('healthBadge').style.borderColor = '#fecaca';
        document.getElementById('healthBadge').style.background = '#fef2f2';
      }
    }

    // ── Init ────────────────────────────────────────────────────
    checkHealth();
    generate();
  </script>
</body>
</html>

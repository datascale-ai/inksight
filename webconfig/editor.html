<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>InkSight - æ¨¡å¼ç¼–è¾‘å™¨</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--bk:#1a1a1a;--wh:#f5f5f0;--gy:#888;--bg:#fafaf7;--bd:#d4d4cf}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--bk);min-height:100vh;display:flex;flex-direction:column}
.toolbar{display:flex;align-items:center;gap:12px;padding:12px 20px;background:var(--bk);color:#fff}
.toolbar h1{font-size:1rem;font-weight:600}
.toolbar select,.toolbar button{padding:6px 14px;border-radius:6px;font-size:.82rem;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.1);color:#fff;cursor:pointer}
.toolbar select option{background:#fff;color:#1a1a1a}
.toolbar button{background:#22c55e;border-color:#22c55e;font-weight:600}
.toolbar button:hover{background:#16a34a}
.toolbar .btn-preview{background:#3b82f6;border-color:#3b82f6}
.toolbar .btn-preview:hover{background:#2563eb}
.toolbar .btn-save{background:#22c55e;border-color:#22c55e}
.main{display:flex;flex:1;overflow:hidden}
.editor-pane{flex:1;display:flex;flex-direction:column;border-right:1px solid var(--bd)}
.preview-pane{width:420px;display:flex;flex-direction:column;background:#fff}
.preview-header{padding:10px 16px;border-bottom:1px solid var(--bd);font-size:.82rem;font-weight:600;color:var(--gy)}
.preview-body{flex:1;display:flex;align-items:center;justify-content:center;padding:16px;overflow:auto}
.preview-body img{max-width:100%;border:1px solid var(--bd);border-radius:4px}
.preview-placeholder{color:var(--gy);font-size:.85rem}
#editor{flex:1;width:100%;padding:16px;font-family:'SF Mono','Fira Code','Consolas',monospace;font-size:.82rem;line-height:1.6;border:none;outline:none;resize:none;background:#1e1e2e;color:#cdd6f4;tab-size:2}
.error-bar{padding:8px 16px;background:#fef2f2;color:#dc2626;font-size:.75rem;border-top:1px solid #fca5a5;display:none}
.error-bar.visible{display:block}
.status-bar{padding:6px 16px;background:#f1f1ee;font-size:.72rem;color:var(--gy);border-top:1px solid var(--bd);display:flex;justify-content:space-between}
</style>
</head>
<body>
<div class="toolbar">
  <h1>ğŸ“ æ¨¡å¼ç¼–è¾‘å™¨</h1>
  <select id="templateSelect" onchange="loadTemplate()">
    <option value="">é€‰æ‹©æ¨¡æ¿...</option>
    <option value="quote">è¯­å½•æ¨¡æ¿ (Quote)</option>
    <option value="list">åˆ—è¡¨æ¨¡æ¿ (List)</option>
    <option value="zen">ç¦…æ„æ¨¡æ¿ (Zen)</option>
    <option value="sections">ç»¼åˆæ¨¡æ¿ (Sections)</option>
  </select>
  <select id="screenSizeSelect" style="padding:6px 10px;border-radius:6px;border:1px solid #d1d5db;font-size:.82rem">
    <option value="400x300">4.2" 400Ã—300</option>
    <option value="296x128">2.9" 296Ã—128</option>
    <option value="800x480">7.5" 800Ã—480</option>
  </select>
  <button class="btn-preview" onclick="doPreview()">â–¶ é¢„è§ˆ</button>
  <button class="btn-save" onclick="doSave()">ğŸ’¾ ä¿å­˜æ¨¡å¼</button>
</div>

<div class="main">
  <div class="editor-pane">
    <textarea id="editor" spellcheck="false"></textarea>
    <div class="error-bar" id="errorBar"></div>
    <div class="status-bar">
      <span id="statusText">å°±ç»ª</span>
      <span id="charCount">0 å­—ç¬¦</span>
    </div>
  </div>
  <div class="preview-pane">
    <div class="preview-header">å®æ—¶é¢„è§ˆ</div>
    <div class="preview-body">
      <div class="preview-placeholder" id="previewArea">ç‚¹å‡»ã€Œé¢„è§ˆã€æŒ‰é’®æŸ¥çœ‹æ•ˆæœ</div>
    </div>
  </div>
</div>

<script>
var TEMPLATES={
quote:{
  mode_id:"MY_QUOTE",display_name:"è‡ªå®šä¹‰è¯­å½•",icon:"book",cacheable:true,
  description:"è‡ªå®šä¹‰è¯­å½•æ¨¡å¼",
  content:{type:"llm_json",prompt_template:"è¯·ç”Ÿæˆä¸€æ¡æœ‰æ·±åº¦çš„è¯­å½•ï¼Œç”¨ JSON è¿”å› {quote, author}ã€‚{context}",
    output_schema:{quote:{type:"string"},author:{type:"string"}},temperature:0.8,
    fallback:{quote:"è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®",author:"å±ˆåŸ"},
    fallback_pool:[{quote:"è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®",author:"å±ˆåŸ"},{quote:"çŸ¥è€…ä¸æƒ‘ï¼Œä»è€…ä¸å¿§",author:"å­”å­"},{quote:"å¤©è¡Œå¥ï¼Œå›å­ä»¥è‡ªå¼ºä¸æ¯",author:"æ˜“ç»"}]
  },
  layout:{status_bar:{line_width:1},body:[{type:"centered_text",field:"quote",font:"NotoSerifSC-Light.ttf",font_size:18,vertical_center:true}],footer:{label:"MY_QUOTE",attribution_template:"â€” {author}"}}
},
list:{
  mode_id:"MY_LIST",display_name:"è‡ªå®šä¹‰åˆ—è¡¨",icon:"list",cacheable:true,
  description:"åˆ—è¡¨å±•ç¤ºæ¨¡å¼",
  content:{type:"llm_json",prompt_template:"è¯·ç”Ÿæˆ3æ¡ç§‘æŠ€å¿«è®¯ï¼ŒJSON æ ¼å¼ {title, items: [{text}]}ã€‚{context}",
    output_schema:{title:{type:"string"},items:{type:"array",items:{type:"object",properties:{text:{type:"string"}}}}},
    temperature:0.7,
    fallback:{title:"ä»Šæ—¥å¿«è®¯",items:[{text:"æš‚æ— å†…å®¹"}]}
  },
  layout:{status_bar:{line_width:1},body:[{type:"text",field:"title",font_size:16,align:"center",bold:true},{type:"spacer",height:8},{type:"list",field:"items",item_template:"{text}",max_items:5,font_size:12}],footer:{label:"MY_LIST"}}
},
zen:{
  mode_id:"MY_ZEN",display_name:"è‡ªå®šä¹‰ç¦…",icon:"zen",cacheable:true,
  description:"å•å­—ç¦…æ„æ¨¡å¼",
  content:{type:"llm_json",prompt_template:"è¯·ç»™å‡ºä¸€ä¸ªè•´å«å“²ç†çš„æ±‰å­—ï¼Œå¹¶ç®€çŸ­è§£è¯»ã€‚JSON: {word, reading}ã€‚{context}",
    output_schema:{word:{type:"string"},reading:{type:"string"}},temperature:0.9,
    fallback:{word:"é“",reading:"ä¸‡ç‰©ä¹‹å§‹"}
  },
  layout:{status_bar:{line_width:1},body:[{type:"centered_text",field:"word",font:"NotoSerifSC-Bold.ttf",font_size:80,vertical_center:true},{type:"centered_text",field:"reading",font_size:13}],footer:{label:"MY_ZEN"}}
},
sections:{
  mode_id:"MY_DAILY",display_name:"è‡ªå®šä¹‰ç»¼åˆ",icon:"daily",cacheable:true,
  description:"å¤šæ ç»¼åˆå†…å®¹",
  content:{type:"llm_json",prompt_template:"è¯·ç”Ÿæˆä»Šæ—¥å†…å®¹ï¼šä¸€å¥è¯è¯­å½•ã€ä¸€ä¸ªæ¨èã€ä¸€ä¸ªå°è´´å£«ã€‚JSON: {quote, recommend, tip}ã€‚{context}",
    output_schema:{quote:{type:"string"},recommend:{type:"string"},tip:{type:"string"}},temperature:0.8,
    fallback:{quote:"ä»Šå¤©æ˜¯ç¾å¥½çš„ä¸€å¤©",recommend:"æ¨èé˜…è¯»",tip:"è®°å¾—å–æ°´"}
  },
  layout:{status_bar:{line_width:1},body:[{type:"section",label:"ğŸ“– è¯­å½•",blocks:[{type:"text",field:"quote",font_size:13}]},{type:"separator",dashed:true},{type:"section",label:"ğŸ’¡ æ¨è",blocks:[{type:"text",field:"recommend",font_size:12}]},{type:"separator",dashed:true},{type:"section",label:"ğŸŒŸ å°è´´å£«",blocks:[{type:"text",field:"tip",font_size:12}]}],footer:{label:"MY_DAILY"}}
}
};

var editor=document.getElementById('editor');
var errorBar=document.getElementById('errorBar');

function loadTemplate(){
  var t=document.getElementById('templateSelect').value;
  if(!t)return;
  editor.value=JSON.stringify(TEMPLATES[t],null,2);
  validateJSON();
  updateCount();
}

function validateJSON(){
  try{
    JSON.parse(editor.value);
    errorBar.textContent='';errorBar.classList.remove('visible');
    document.getElementById('statusText').textContent='JSON æœ‰æ•ˆ âœ“';
    return true;
  }catch(e){
    errorBar.textContent='JSON é”™è¯¯: '+e.message;
    errorBar.classList.add('visible');
    document.getElementById('statusText').textContent='JSON æ— æ•ˆ âœ—';
    return false;
  }
}

function updateCount(){
  document.getElementById('charCount').textContent=editor.value.length+' å­—ç¬¦';
}

editor.addEventListener('input',function(){validateJSON();updateCount();});

editor.addEventListener('keydown',function(e){
  if(e.key==='Tab'){
    e.preventDefault();
    var s=this.selectionStart,en=this.selectionEnd;
    this.value=this.value.substring(0,s)+'  '+this.value.substring(en);
    this.selectionStart=this.selectionEnd=s+2;
  }
});

function doPreview(){
  if(!validateJSON())return;
  var def=JSON.parse(editor.value);
  var dims=document.getElementById('screenSizeSelect').value.split('x').map(Number);
  document.getElementById('previewArea').innerHTML='<div class="preview-placeholder">åŠ è½½ä¸­...</div>';
  fetch('/api/modes/custom/preview',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({mode_def:def,w:dims[0],h:dims[1]})
  }).then(function(r){
    if(!r.ok){
      return r.json().then(function(d){ throw new Error(d.error||('Preview failed: '+r.status)); }).catch(function(parseErr){ throw new Error('Preview failed: '+r.status); });
    }
    return r.blob();
  }).then(function(blob){
    var url=URL.createObjectURL(blob);
    document.getElementById('previewArea').innerHTML='<img src="'+url+'" alt="Preview">';
  }).catch(function(e){
    document.getElementById('previewArea').innerHTML='<div class="preview-placeholder" style="color:#dc2626">é¢„è§ˆå¤±è´¥: '+e.message+'</div>';
  });
}

function doSave(){
  if(!validateJSON())return;
  var def=JSON.parse(editor.value);
  if(!def.mode_id){alert('è¯·è®¾ç½® mode_id');return;}
  fetch('/api/modes/custom',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify(def)
  }).then(function(r){return r.json()}).then(function(d){
    if(d.ok||d.status==='ok'){
      document.getElementById('statusText').textContent='ä¿å­˜æˆåŠŸ âœ“';
      alert('æ¨¡å¼ '+def.mode_id+' ä¿å­˜æˆåŠŸï¼');
    }else{
      alert('ä¿å­˜å¤±è´¥: '+(d.error||d.message||'æœªçŸ¥é”™è¯¯'));
    }
  }).catch(function(e){
    alert('ä¿å­˜å¤±è´¥: '+e.message);
  });
}

// Load quote template by default
editor.value=JSON.stringify(TEMPLATES.quote,null,2);
validateJSON();
updateCount();
</script>
</body>
</html>
